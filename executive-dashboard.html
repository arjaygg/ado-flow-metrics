<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Metrics Executive Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="js/workstream_config.js"></script>
    <script src="js/workstream-manager.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .executive-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }

        .kpi-card.success { border-left-color: var(--success-color); }
        .kpi-card.warning { border-left-color: var(--warning-color); }
        .kpi-card.danger { border-left-color: var(--danger-color); }
        .kpi-card.info { border-left-color: var(--info-color); }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }

        .kpi-label {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #7f8c8d;
        }

        .kpi-trend {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }
        .trend-stable { color: var(--info-color); }

        .chart-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ecf0f1;
        }

        .data-source-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .executive-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .benchmark-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .benchmark-excellent { background-color: var(--success-color); }
        .benchmark-good { background-color: var(--info-color); }
        .benchmark-needs-improvement { background-color: var(--warning-color); }
        .benchmark-critical { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <!-- Executive Header -->
    <div class="executive-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-chart-line me-3"></i>Flow Metrics Executive Dashboard
                    </h1>
                    <p class="mb-0 opacity-75">Team Performance & Delivery Insights</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-light me-2" id="refreshBtn">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                    <button class="btn btn-light" id="loadDataBtn">
                        <i class="fas fa-upload me-2"></i>Load Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Data Source Panel -->
        <div class="data-source-panel">
            <div class="row align-items-center mb-3">
                <div class="col-md-6">
                    <h6 class="mb-1"><i class="fas fa-database me-2"></i>Data Source</h6>
                    <small class="text-muted" id="dataSourceInfo">Select data source to begin</small>
                </div>
                <div class="col-md-6">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="dataSource" id="mockData" checked>
                        <label class="btn btn-outline-primary" for="mockData">Demo Data</label>

                        <input type="radio" class="btn-check" name="dataSource" id="jsonFile">
                        <label class="btn btn-outline-primary" for="jsonFile">Upload Report</label>

                        <input type="radio" class="btn-check" name="dataSource" id="indexedDB">
                        <label class="btn btn-outline-primary" for="indexedDB">Saved Data</label>

                        <input type="radio" class="btn-check" name="dataSource" id="cliData">
                        <label class="btn btn-outline-primary" for="cliData">CLI Data</label>
                    </div>
                </div>
            </div>
            <!-- Executive Work Item Type Filter -->
            <div class="row align-items-center mb-3">
                <div class="col-md-6">
                    <h6 class="mb-1"><i class="fas fa-tags me-2"></i>Work Item Type Focus</h6>
                    <small class="text-muted" id="executiveWorkItemTypeInfo">All types included</small>
                </div>
                <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-outline-info dropdown-toggle w-100" type="button" id="executiveWorkItemTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-tags me-2"></i>All Types
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="executiveWorkItemTypeDropdown" id="executiveWorkItemTypeDropdownMenu">
                            <li><a class="dropdown-item" href="#" data-work-item-type="All Types">
                                <input type="checkbox" class="form-check-input me-2" checked> All Types
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-work-item-type="User Story">
                                <input type="checkbox" class="form-check-input me-2"> User Story
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-work-item-type="Bug">
                                <input type="checkbox" class="form-check-input me-2"> Bug
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-work-item-type="Task">
                                <input type="checkbox" class="form-check-input me-2"> Task
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-work-item-type="Feature">
                                <input type="checkbox" class="form-check-input me-2"> Feature
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-work-item-type="Epic">
                                <input type="checkbox" class="form-check-input me-2"> Epic
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-work-item-type="Issue">
                                <input type="checkbox" class="form-check-input me-2"> Issue
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Executive Sprint Filter -->
            <div class="row align-items-center mb-3">
                <div class="col-md-6">
                    <h6 class="mb-1"><i class="fas fa-running me-2"></i>Sprint Focus</h6>
                    <small class="text-muted" id="executiveSprintInfo">All sprints included</small>
                </div>
                <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-outline-warning dropdown-toggle w-100" type="button" id="executiveSprintDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-running me-2"></i>All Sprints
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="executiveSprintDropdown" id="executiveSprintDropdownMenu">
                            <li><a class="dropdown-item" href="#" data-sprint="All Sprints">
                                <input type="checkbox" class="form-check-input me-2" checked> All Sprints
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <!-- Sprint options will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Executive Workstream Filter -->
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-1"><i class="fas fa-project-diagram me-2"></i>Workstream Focus</h6>
                    <small class="text-muted" id="workstreamInfo">All workstreams included</small>
                </div>
                <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="workstreamDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-chart-pie me-2"></i>All Workstreams
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="workstreamDropdown" id="workstreamDropdownMenu">
                            <li><a class="dropdown-item" href="#" data-workstream="All Teams">
                                <input type="checkbox" class="form-check-input me-2" checked> All Workstreams
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <!-- Workstream options will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="executive-summary">
            <h4 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Executive Summary</h4>
            <div class="row">
                <div class="col-md-8">
                    <p class="mb-2" id="summaryText">Loading executive summary...</p>
                    <div class="mt-3">
                        <h6>Key Insights:</h6>
                        <ul id="keyInsights" class="mb-0">
                            <li>Loading insights...</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>Performance Benchmarks</h6>
                    <div class="mt-2">
                        <div><span class="benchmark-indicator benchmark-excellent"></span>Excellent (Top 25%)</div>
                        <div><span class="benchmark-indicator benchmark-good"></span>Good (Average)</div>
                        <div><span class="benchmark-indicator benchmark-needs-improvement"></span>Needs Improvement</div>
                        <div><span class="benchmark-indicator benchmark-critical"></span>Critical</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Performance Indicators -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">Delivery Speed</div>
                            <div class="kpi-value text-primary" id="deliverySpeed">--</div>
                            <div class="kpi-trend" id="deliveryTrend">
                                <i class="fas fa-minus"></i> No trend data
                            </div>
                        </div>
                        <div class="text-primary opacity-25">
                            <i class="fas fa-tachometer-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card success">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">Flow Efficiency</div>
                            <div class="kpi-value text-success" id="flowEfficiency">--%</div>
                            <div class="kpi-trend" id="efficiencyTrend">
                                <i class="fas fa-minus"></i> No trend data
                            </div>
                        </div>
                        <div class="text-success opacity-25">
                            <i class="fas fa-stream fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card warning">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">Work in Progress</div>
                            <div class="kpi-value text-warning" id="wipItems">--</div>
                            <div class="kpi-trend" id="wipTrend">
                                <i class="fas fa-minus"></i> No trend data
                            </div>
                        </div>
                        <div class="text-warning opacity-25">
                            <i class="fas fa-tasks fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card info">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">Team Velocity</div>
                            <div class="kpi-value text-info" id="teamVelocity">--</div>
                            <div class="kpi-trend" id="velocityTrend">
                                <i class="fas fa-minus"></i> No trend data
                            </div>
                        </div>
                        <div class="text-info opacity-25">
                            <i class="fas fa-rocket fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1: Delivery Performance -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-area me-2"></i>Delivery Performance Trends
                    </h5>
                    <div id="deliveryTrendsChart" style="height: 350px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-gauge me-2"></i>Flow Efficiency Score
                    </h5>
                    <div id="efficiencyGauge" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2: Capacity & Flow -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-project-diagram me-2"></i>Work Distribution
                    </h5>
                    <div id="workDistributionChart" style="height: 300px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-bar me-2"></i>Throughput Analysis
                    </h5>
                    <div id="throughputChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Defect Ratio Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="chart-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="chart-title mb-0">
                            <i class="fas fa-bug me-2"></i>Defect Ratio Analysis
                        </h5>
                        <div class="d-flex align-items-center gap-3">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-danger dropdown-toggle" type="button" id="defectTypesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-cog me-1"></i>Configure Types
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="defectTypesDropdown" id="defectTypesDropdownMenu">
                                    <li class="dropdown-header">Bug Types</li>
                                    <li><a class="dropdown-item" href="#" data-defect-type="Bug">
                                        <input type="checkbox" class="form-check-input me-2" checked> Bug
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-defect-type="Defect">
                                        <input type="checkbox" class="form-check-input me-2" checked> Defect
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-defect-type="Issue">
                                        <input type="checkbox" class="form-check-input me-2" checked> Issue
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="dropdown-header">Denominator Types</li>
                                    <li><a class="dropdown-item" href="#" data-denominator-type="All">
                                        <input type="radio" class="form-check-input me-2" name="denominatorType" value="All" checked> All Work Items
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-denominator-type="Selected">
                                        <input type="radio" class="form-check-input me-2" name="denominatorType" value="Selected"> Selected Types Only
                                    </a></li>
                                </ul>
                            </div>
                            <div class="badge bg-info" id="defectRatioValue">0.0%</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-8">
                            <div id="defectRatioChart" style="height: 350px;"></div>
                        </div>
                        <div class="col-lg-4">
                            <div class="p-3">
                                <h6 class="mb-3">Configuration Summary</h6>
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Bug Types:</small>
                                    <div id="bugTypesList" class="small">Bug, Defect, Issue</div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Denominator:</small>
                                    <div id="denominatorTypeText" class="small">All Work Items</div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Calculation:</small>
                                    <div class="small">
                                        <span id="bugCount">0</span> bugs / <span id="totalCount">0</span> total items
                                    </div>
                                </div>
                                <div class="alert alert-light small mb-0">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Adjust the work item types to customize the defect ratio calculation for your specific needs.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Capacity Overview -->
        <div class="row">
            <div class="col-12">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-users me-2"></i>Team Capacity & Performance Overview
                    </h5>
                    <div class="row" id="teamOverview">
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <h4 class="text-primary mb-1" id="totalTeamSize">--</h4>
                                <small class="text-muted">Team Members</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <h4 class="text-success mb-1" id="avgCompletionRate">--%</h4>
                                <small class="text-muted">Avg Completion Rate</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <h4 class="text-info mb-1" id="avgLeadTime">-- days</h4>
                                <small class="text-muted">Avg Lead Time</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <h4 class="text-warning mb-1" id="teamUtilization">--%</h4>
                                <small class="text-muted">Team Utilization</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Executive Flow Metrics Dashboard
        class ExecutiveDashboard {
            constructor() {
                this.data = null;
                this.dbName = 'FlowMetricsExecutiveDB';
                this.dbVersion = 1;
                this.db = null;
                this.workstreamManager = new WorkstreamManager();
                this.selectedWorkstreams = ['All Teams'];
                this.selectedWorkItemTypes = ['All Types'];
                this.selectedSprints = ['All Sprints'];
                this.availableSprints = [];
                this.defectRatioConfig = {
                    bugTypes: ['Bug', 'Defect', 'Issue'],
                    denominatorType: 'All'
                };
                this.init();
            }

            async init() {
                await this.initIndexedDB();
                await this.initWorkstreams();
                this.setupEventListeners();
                this.loadData();
            }

            async initWorkstreams() {
                try {
                    await this.workstreamManager.init();
                    this.populateWorkstreamFilter();
                    console.log('Executive workstream filtering initialized');
                } catch (error) {
                    console.error('Failed to initialize executive workstream filtering:', error);
                }
            }

            populateWorkstreamFilter() {
                const menu = document.getElementById('workstreamDropdownMenu');
                const workstreams = this.workstreamManager.getAvailableWorkstreams();

                // Clear existing workstream items (keep All Teams)
                const existingItems = menu.querySelectorAll('[data-workstream]:not([data-workstream="All Teams"])');
                existingItems.forEach(item => item.parentElement.remove());

                // Add workstream options
                workstreams.forEach(workstream => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a class="dropdown-item" href="#" data-workstream="${workstream}">
                            <input type="checkbox" class="form-check-input me-2"> ${workstream}
                        </a>
                    `;
                    menu.appendChild(li);
                });
            }

            async initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('executive_metrics')) {
                            const store = db.createObjectStore('executive_metrics', { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };
                });
            }

            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadData());
                document.getElementById('loadDataBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileLoad(e));
                document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                    radio.addEventListener('change', () => this.loadData());
                });

                // Workstream filter
                document.getElementById('workstreamDropdownMenu').addEventListener('click', (e) => {
                    this.handleWorkstreamFilter(e);
                });

                // Executive Work Item Type filter
                document.getElementById('executiveWorkItemTypeDropdownMenu').addEventListener('click', (e) => {
                    this.handleExecutiveWorkItemTypeFilter(e);
                });

                // Executive Sprint filter
                document.getElementById('executiveSprintDropdownMenu').addEventListener('click', (e) => {
                    this.handleExecutiveSprintFilter(e);
                });

                // Defect ratio configuration
                document.getElementById('defectTypesDropdownMenu').addEventListener('click', (e) => {
                    this.handleDefectRatioConfig(e);
                });
            }

            async loadData() {
                const selectedSource = document.querySelector('input[name="dataSource"]:checked').id;

                try {
                    let data = null;

                    switch (selectedSource) {
                        case 'mockData':
                            data = this.generateExecutiveMockData();
                            this.updateDataSourceInfo('Executive demo data loaded');
                            break;
                        case 'jsonFile':
                            data = this.data;
                            this.updateDataSourceInfo(data ? 'Report file loaded' : 'No report file loaded');
                            break;
                        case 'indexedDB':
                            data = await this.loadFromIndexedDB();
                            this.updateDataSourceInfo(data ? 'Data loaded from browser storage' : 'No saved data found');
                            break;
                        case 'cliData':
                            data = await this.loadFromCLI();
                            this.updateDataSourceInfo(data ? 'CLI data loaded successfully' : 'No CLI data available');
                            break;
                    }

                    if (data) {
                        this.data = data;
                        this.populateExecutiveSprintFilter(data);
                        this.updateExecutiveDashboard(data);

                        if (selectedSource !== 'indexedDB') {
                            await this.saveToIndexedDB(data);
                        }
                    } else {
                        this.showNoDataMessage();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showErrorMessage(error.message);
                }
            }

            handleFileLoad(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.data = data;
                        document.getElementById('jsonFile').checked = true;
                        this.updateDataSourceInfo(`Report: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
                        this.updateExecutiveDashboard(data);
                        this.saveToIndexedDB(data);
                    } catch (error) {
                        alert('Error parsing report file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            async saveToIndexedDB(data) {
                const transaction = this.db.transaction(['executive_metrics'], 'readwrite');
                const store = transaction.objectStore('executive_metrics');
                await store.put({
                    id: 'latest',
                    timestamp: new Date().toISOString(),
                    data: data
                });
            }

            async loadFromIndexedDB() {
                const transaction = this.db.transaction(['executive_metrics'], 'readonly');
                const store = transaction.objectStore('executive_metrics');
                return new Promise((resolve) => {
                    const request = store.get('latest');
                    request.onsuccess = () => resolve(request.result ? request.result.data : null);
                    request.onerror = () => resolve(null);
                });
            }

            // Load data from CLI-generated files
            async loadFromCLI() {
                try {
                    // Try multiple CLI data locations
                    const dataSources = [
                        './data/dashboard_data.json',
                        './data/flow_metrics_report.json',
                        './data/test_report.json',
                        './data/test_metrics_report.json'
                    ];

                    for (const source of dataSources) {
                        try {
                            const response = await fetch(source);
                            if (response.ok) {
                                const data = await response.json();
                                console.log(`Successfully loaded executive data from ${source}`);

                                // Handle different data formats
                                if (data.data) {
                                    return data.data; // Dashboard format
                                } else if (data.summary || data.lead_time || data.cycle_time) {
                                    return data; // Direct metrics format
                                }
                            }
                        } catch (err) {
                            console.log(`Failed to load from ${source}: ${err.message}`);
                        }
                    }

                    console.log('No CLI data found in any location');
                    return null;
                } catch (error) {
                    console.log('CLI data loading error:', error.message);
                    return null;
                }
            }

            updateDataSourceInfo(message) {
                document.getElementById('dataSourceInfo').textContent = message + ' • ' + new Date().toLocaleTimeString();
            }

            populateExecutiveSprintFilter(data) {
                const menu = document.getElementById('executiveSprintDropdownMenu');
                const sprints = data.sprints || Object.keys(data.items_by_sprint || {});
                
                this.availableSprints = sprints;

                // Clear existing sprint items (keep All Sprints)
                const existingItems = menu.querySelectorAll('[data-sprint]:not([data-sprint="All Sprints"])');
                existingItems.forEach(item => item.parentElement.remove());

                // Add sprint options
                sprints.forEach(sprint => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a class="dropdown-item" href="#" data-sprint="${sprint}">
                            <input type="checkbox" class="form-check-input me-2"> ${sprint}
                        </a>
                    `;
                    menu.appendChild(li);
                });
            }

            handleExecutiveWorkItemTypeFilter(event) {
                event.preventDefault();
                const target = event.target.closest('[data-work-item-type]');
                if (!target) return;

                const workItemType = target.getAttribute('data-work-item-type');
                const checkbox = target.querySelector('input[type="checkbox"]');

                if (workItemType === 'All Types') {
                    if (checkbox.checked) {
                        this.selectedWorkItemTypes = ['All Types'];
                        document.querySelectorAll('#executiveWorkItemTypeDropdownMenu input[type="checkbox"]').forEach(cb => {
                            cb.checked = cb.closest('[data-work-item-type]').getAttribute('data-work-item-type') === 'All Types';
                        });
                    } else {
                        checkbox.checked = true;
                        return;
                    }
                } else {
                    const allTypesCheckbox = document.querySelector('#executiveWorkItemTypeDropdownMenu [data-work-item-type="All Types"] input');
                    if (checkbox.checked) {
                        if (this.selectedWorkItemTypes.includes('All Types')) {
                            this.selectedWorkItemTypes = [workItemType];
                            allTypesCheckbox.checked = false;
                        } else if (!this.selectedWorkItemTypes.includes(workItemType)) {
                            this.selectedWorkItemTypes.push(workItemType);
                        }
                    } else {
                        this.selectedWorkItemTypes = this.selectedWorkItemTypes.filter(w => w !== workItemType);
                        if (this.selectedWorkItemTypes.length === 0) {
                            this.selectedWorkItemTypes = ['All Types'];
                            allTypesCheckbox.checked = true;
                        }
                    }
                }

                this.updateExecutiveWorkItemTypeDisplay();
                this.updateExecutiveDashboard(this.data);
            }

            handleExecutiveSprintFilter(event) {
                event.preventDefault();
                const target = event.target.closest('[data-sprint]');
                if (!target) return;

                const sprint = target.getAttribute('data-sprint');
                const checkbox = target.querySelector('input[type="checkbox"]');

                if (sprint === 'All Sprints') {
                    if (checkbox.checked) {
                        this.selectedSprints = ['All Sprints'];
                        document.querySelectorAll('#executiveSprintDropdownMenu input[type="checkbox"]').forEach(cb => {
                            cb.checked = cb.closest('[data-sprint]').getAttribute('data-sprint') === 'All Sprints';
                        });
                    } else {
                        checkbox.checked = true;
                        return;
                    }
                } else {
                    const allSprintsCheckbox = document.querySelector('#executiveSprintDropdownMenu [data-sprint="All Sprints"] input');
                    if (checkbox.checked) {
                        if (this.selectedSprints.includes('All Sprints')) {
                            this.selectedSprints = [sprint];
                            allSprintsCheckbox.checked = false;
                        } else if (!this.selectedSprints.includes(sprint)) {
                            this.selectedSprints.push(sprint);
                        }
                    } else {
                        this.selectedSprints = this.selectedSprints.filter(s => s !== sprint);
                        if (this.selectedSprints.length === 0) {
                            this.selectedSprints = ['All Sprints'];
                            allSprintsCheckbox.checked = true;
                        }
                    }
                }

                this.updateExecutiveSprintDisplay();
                this.updateExecutiveDashboard(this.data);
            }

            handleDefectRatioConfig(event) {
                event.preventDefault();
                const target = event.target.closest('[data-defect-type], [data-denominator-type]');
                if (!target) return;

                if (target.hasAttribute('data-defect-type')) {
                    const defectType = target.getAttribute('data-defect-type');
                    const checkbox = target.querySelector('input[type="checkbox"]');
                    
                    if (checkbox.checked) {
                        if (!this.defectRatioConfig.bugTypes.includes(defectType)) {
                            this.defectRatioConfig.bugTypes.push(defectType);
                        }
                    } else {
                        this.defectRatioConfig.bugTypes = this.defectRatioConfig.bugTypes.filter(t => t !== defectType);
                    }
                } else if (target.hasAttribute('data-denominator-type')) {
                    const denominatorType = target.getAttribute('data-denominator-type');
                    const radio = target.querySelector('input[type="radio"]');
                    
                    if (radio.checked) {
                        this.defectRatioConfig.denominatorType = denominatorType;
                    }
                }

                this.updateDefectRatioConfigDisplay();
                this.updateDefectRatioChart(this.data);
            }

            updateExecutiveWorkItemTypeDisplay() {
                const button = document.getElementById('executiveWorkItemTypeDropdown');
                const info = document.getElementById('executiveWorkItemTypeInfo');

                if (this.selectedWorkItemTypes.includes('All Types')) {
                    button.innerHTML = '<i class="fas fa-tags me-2"></i>All Types';
                    info.textContent = 'All types included';
                } else if (this.selectedWorkItemTypes.length === 1) {
                    button.innerHTML = `<i class="fas fa-tags me-2"></i>${this.selectedWorkItemTypes[0]}`;
                    info.textContent = `Executive view filtered to ${this.selectedWorkItemTypes[0]} items`;
                } else {
                    button.innerHTML = `<i class="fas fa-tags me-2"></i>${this.selectedWorkItemTypes.length} Types`;
                    info.textContent = `Executive view of ${this.selectedWorkItemTypes.length} types: ${this.selectedWorkItemTypes.join(', ')}`;
                }
            }

            updateExecutiveSprintDisplay() {
                const button = document.getElementById('executiveSprintDropdown');
                const info = document.getElementById('executiveSprintInfo');

                if (this.selectedSprints.includes('All Sprints')) {
                    button.innerHTML = '<i class="fas fa-running me-2"></i>All Sprints';
                    info.textContent = 'All sprints included';
                } else if (this.selectedSprints.length === 1) {
                    button.innerHTML = `<i class="fas fa-running me-2"></i>${this.selectedSprints[0]}`;
                    info.textContent = `Executive view filtered to ${this.selectedSprints[0]}`;
                } else {
                    button.innerHTML = `<i class="fas fa-running me-2"></i>${this.selectedSprints.length} Sprints`;
                    info.textContent = `Executive view of ${this.selectedSprints.length} sprints: ${this.selectedSprints.join(', ')}`;
                }
            }

            updateDefectRatioConfigDisplay() {
                document.getElementById('bugTypesList').textContent = this.defectRatioConfig.bugTypes.join(', ');
                document.getElementById('denominatorTypeText').textContent = 
                    this.defectRatioConfig.denominatorType === 'All' ? 'All Work Items' : 'Selected Types Only';
            }

            updateDefectRatioChart(data) {
                const itemsByType = data.items_by_type || {};
                
                // Calculate defect ratio based on configuration
                let bugCount = 0;
                let totalCount = 0;

                // Count bugs based on configured bug types
                this.defectRatioConfig.bugTypes.forEach(bugType => {
                    bugCount += itemsByType[bugType] || 0;
                });

                // Calculate total based on denominator configuration
                if (this.defectRatioConfig.denominatorType === 'All') {
                    totalCount = Object.values(itemsByType).reduce((sum, count) => sum + count, 0);
                } else {
                    // Use only selected work item types
                    if (this.selectedWorkItemTypes.includes('All Types')) {
                        totalCount = Object.values(itemsByType).reduce((sum, count) => sum + count, 0);
                    } else {
                        this.selectedWorkItemTypes.forEach(type => {
                            totalCount += itemsByType[type] || 0;
                        });
                    }
                }

                const defectRatio = totalCount > 0 ? (bugCount / totalCount) * 100 : 0;
                const nonBugCount = totalCount - bugCount;

                // Update display values
                document.getElementById('defectRatioValue').textContent = `${defectRatio.toFixed(1)}%`;
                document.getElementById('bugCount').textContent = bugCount;
                document.getElementById('totalCount').textContent = totalCount;

                // Create chart
                const chartData = [{
                    values: [nonBugCount, bugCount],
                    labels: ['Non-Defects', 'Defects'],
                    type: 'pie',
                    hole: 0.6,
                    marker: {
                        colors: ['#27ae60', '#e74c3c']
                    },
                    textinfo: 'label+percent',
                    textposition: 'outside'
                }];

                const layout = {
                    margin: { l: 20, r: 20, t: 20, b: 20 },
                    showlegend: true,
                    legend: { 
                        orientation: 'h', 
                        y: -0.1,
                        x: 0.5,
                        xanchor: 'center'
                    },
                    annotations: [{
                        font: { size: 20, color: '#2c3e50' },
                        showarrow: false,
                        text: `${defectRatio.toFixed(1)}%`,
                        x: 0.5,
                        y: 0.5
                    }]
                };

                Plotly.newPlot('defectRatioChart', chartData, layout, { responsive: true });
            }

            updateExecutiveDashboard(data) {
                this.updateExecutiveSummary(data);
                this.updateKPIs(data);
                this.updateCharts(data);
                this.updateDefectRatioChart(data);
                this.updateTeamOverview(data);
            }

            updateExecutiveSummary(data) {
                const summary = data.summary || {};
                const leadTime = data.lead_time || {};
                const efficiency = data.flow_efficiency || {};
                const wip = data.work_in_progress || {};
                let teamMetrics = data.team_metrics || {};

                // Apply workstream filtering for summary calculations
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);
                const filteredTeamSize = Object.keys(teamMetrics).length;

                // Calculate filtered metrics
                let filteredCompleted = 0;
                let filteredActive = 0;
                Object.values(teamMetrics).forEach(member => {
                    filteredCompleted += member.completed_items || 0;
                    filteredActive += member.active_items || 0;
                });

                const totalFiltered = filteredCompleted + filteredActive;
                const filteredCompletionRate = totalFiltered > 0 ? (filteredCompleted / totalFiltered) * 100 : 0;

                // Executive summary text with workstream context
                let summaryText;
                if (this.selectedWorkstreams.includes('All Teams')) {
                    summaryText = `Team delivered ${summary.completed_items || 0} items out of ${summary.total_work_items || 0} total items (${(summary.completion_rate || 0).toFixed(1)}% completion rate). Average delivery time is ${(leadTime.average_days || 0).toFixed(1)} days with ${((efficiency.average_efficiency || 0) * 100).toFixed(1)}% flow efficiency.`;
                } else {
                    const workstreamNames = this.selectedWorkstreams.join(', ');
                    summaryText = `${workstreamNames} workstream(s) with ${filteredTeamSize} team members delivered ${filteredCompleted} items with ${filteredCompletionRate.toFixed(1)}% completion rate. Average delivery time is ${(leadTime.average_days || 0).toFixed(1)} days with ${((efficiency.average_efficiency || 0) * 100).toFixed(1)}% flow efficiency.`;
                }

                document.getElementById('summaryText').textContent = summaryText;

                // Key insights
                const insights = this.generateExecutiveInsights(data);
                const insightsList = document.getElementById('keyInsights');
                insightsList.innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
            }

            generateExecutiveInsights(data) {
                const insights = [];
                const leadTime = data.lead_time || {};
                const efficiency = data.flow_efficiency || {};
                const throughput = data.throughput || {};
                const wip = data.work_in_progress || {};

                // Lead time insights
                if (leadTime.average_days < 10) {
                    insights.push('🟢 Excellent delivery speed - under 10 days average lead time');
                } else if (leadTime.average_days > 20) {
                    insights.push('🔴 Delivery speed needs attention - over 20 days average lead time');
                } else {
                    insights.push('🟡 Moderate delivery speed - room for improvement');
                }

                // Flow efficiency insights
                const efficiencyPercent = (efficiency.average_efficiency || 0) * 100;
                if (efficiencyPercent > 70) {
                    insights.push('🟢 High flow efficiency - minimal waste in process');
                } else if (efficiencyPercent < 40) {
                    insights.push('🔴 Low flow efficiency - significant process bottlenecks detected');
                } else {
                    insights.push('🟡 Moderate flow efficiency - optimization opportunities exist');
                }

                // WIP insights
                if (wip.total_wip > 100) {
                    insights.push('🔴 High work in progress - may impact delivery speed');
                } else if (wip.total_wip < 30) {
                    insights.push('🟢 Well-managed work in progress levels');
                } else {
                    insights.push('🟡 Moderate WIP levels - monitor for trends');
                }

                // Throughput insights
                if (throughput.items_per_period > 25) {
                    insights.push('🟢 Strong team velocity - high throughput achieved');
                } else if (throughput.items_per_period < 10) {
                    insights.push('🔴 Low team velocity - capacity constraints detected');
                }

                return insights;
            }

            updateKPIs(data) {
                const leadTime = data.lead_time || {};
                const efficiency = data.flow_efficiency || {};
                const throughput = data.throughput || {};
                const wip = data.work_in_progress || {};
                let teamMetrics = data.team_metrics || {};

                // Apply workstream filtering to team metrics for KPI calculations
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);

                // If workstream filtering is active, recalculate KPIs from filtered data
                if (!this.selectedWorkstreams.includes('All Teams') && Object.keys(teamMetrics).length > 0) {
                    // Calculate filtered metrics
                    let filteredCompleted = 0;
                    let filteredActive = 0;
                    let totalLeadTime = 0;
                    let leadTimeCount = 0;

                    Object.values(teamMetrics).forEach(member => {
                        filteredCompleted += member.completed_items || 0;
                        filteredActive += member.active_items || 0;
                        if (member.average_lead_time) {
                            totalLeadTime += member.average_lead_time;
                            leadTimeCount++;
                        }
                    });

                    const filteredAvgLeadTime = leadTimeCount > 0 ? totalLeadTime / leadTimeCount : (leadTime.average_days || 0);
                    const filteredThroughput = filteredCompleted > 0 ? (filteredCompleted / 30) : (throughput.items_per_period || 0);
                    const filteredWip = filteredActive;

                    // Update KPIs with filtered data
                    document.getElementById('deliverySpeed').textContent = `${filteredAvgLeadTime.toFixed(1)} days`;
                    document.getElementById('flowEfficiency').textContent = `${((efficiency.average_efficiency || 0) * 100).toFixed(1)}%`;
                    document.getElementById('wipItems').textContent = filteredWip;
                    document.getElementById('teamVelocity').textContent = `${filteredThroughput.toFixed(1)}/mo`;
                } else {
                    // Use original aggregate data for "All Teams"
                    document.getElementById('deliverySpeed').textContent = `${(leadTime.average_days || 0).toFixed(1)} days`;
                    document.getElementById('flowEfficiency').textContent = `${((efficiency.average_efficiency || 0) * 100).toFixed(1)}%`;
                    document.getElementById('wipItems').textContent = wip.total_wip || 0;
                    document.getElementById('teamVelocity').textContent = `${(throughput.items_per_period || 0).toFixed(1)}/mo`;
                }

                // Add trend indicators (simplified for demo)
                this.updateTrendIndicator('deliveryTrend', 'stable');
                this.updateTrendIndicator('efficiencyTrend', 'up');
                this.updateTrendIndicator('wipTrend', 'down');
                this.updateTrendIndicator('velocityTrend', 'up');
            }

            updateTrendIndicator(elementId, trend) {
                const element = document.getElementById(elementId);
                const trends = {
                    'up': { icon: 'fa-arrow-up', class: 'trend-up', text: 'Improving' },
                    'down': { icon: 'fa-arrow-down', class: 'trend-down', text: 'Declining' },
                    'stable': { icon: 'fa-minus', class: 'trend-stable', text: 'Stable' }
                };

                const trendData = trends[trend];
                element.innerHTML = `<i class="fas ${trendData.icon}"></i> ${trendData.text}`;
                element.className = `kpi-trend ${trendData.class}`;
            }

            updateCharts(data) {
                this.updateDeliveryTrendsChart(data);
                this.updateEfficiencyGauge(data);
                this.updateWorkDistributionChart(data);
                this.updateThroughputChart(data);
            }

            updateDeliveryTrendsChart(data) {
                // Simulate trend data
                const days = 30;
                const leadTimeData = [];
                const cycleTimeData = [];

                for (let i = days; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);

                    leadTimeData.push({
                        x: date.toISOString().split('T')[0],
                        y: Math.random() * 5 + 8 // 8-13 days
                    });

                    cycleTimeData.push({
                        x: date.toISOString().split('T')[0],
                        y: Math.random() * 4 + 6 // 6-10 days
                    });
                }

                const chartData = [
                    {
                        x: leadTimeData.map(d => d.x),
                        y: leadTimeData.map(d => d.y),
                        name: 'Lead Time',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#3498db', width: 3 },
                        marker: { size: 6 }
                    },
                    {
                        x: cycleTimeData.map(d => d.x),
                        y: cycleTimeData.map(d => d.y),
                        name: 'Cycle Time',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#27ae60', width: 3 },
                        marker: { size: 6 }
                    }
                ];

                const layout = {
                    margin: { l: 60, r: 40, t: 20, b: 60 },
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Days' },
                    showlegend: true,
                    legend: { x: 0, y: 1 }
                };

                Plotly.newPlot('deliveryTrendsChart', chartData, layout, { responsive: true });
            }

            updateEfficiencyGauge(data) {
                const efficiency = data.flow_efficiency || {};
                let value = (efficiency.average_efficiency || 0) * 100;

                // Apply workstream filtering to efficiency calculation
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    const filteredTeamMetrics = this.workstreamManager.filterTeamMetrics(data.team_metrics || {}, this.selectedWorkstreams);
                    
                    if (Object.keys(filteredTeamMetrics).length > 0) {
                        // Recalculate efficiency for filtered teams
                        const efficiencyValues = Object.values(filteredTeamMetrics)
                            .map(member => member.flow_efficiency || member.efficiency || 0)
                            .filter(eff => eff > 0);
                        
                        if (efficiencyValues.length > 0) {
                            const avgEfficiency = efficiencyValues.reduce((sum, eff) => sum + eff, 0) / efficiencyValues.length;
                            value = avgEfficiency * 100;
                        }
                    }
                }

                const chartData = [{
                    domain: { x: [0, 1], y: [0, 1] },
                    value: value,
                    title: { text: "Flow Efficiency %" },
                    type: "indicator",
                    mode: "gauge+number",
                    gauge: {
                        axis: { range: [null, 100] },
                        bar: { color: value > 70 ? "#27ae60" : value > 40 ? "#f39c12" : "#e74c3c" },
                        steps: [
                            { range: [0, 40], color: "#ecf0f1" },
                            { range: [40, 70], color: "#f8f9fa" },
                            { range: [70, 100], color: "#e8f5e8" }
                        ],
                        threshold: {
                            line: { color: "#2c3e50", width: 4 },
                            thickness: 0.75,
                            value: 70
                        }
                    }
                }];

                const layout = {
                    margin: { l: 20, r: 20, t: 20, b: 20 }
                };

                Plotly.newPlot('efficiencyGauge', chartData, layout, { responsive: true });
            }

            updateWorkDistributionChart(data) {
                const wip = data.work_in_progress || {};
                let wipByState = wip.wip_by_state || {};

                // Apply workstream filtering to WIP data
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    const filteredTeamMetrics = this.workstreamManager.filterTeamMetrics(data.team_metrics || {}, this.selectedWorkstreams);
                    
                    if (Object.keys(filteredTeamMetrics).length > 0) {
                        // Recalculate WIP by state for filtered teams
                        wipByState = {};
                        Object.values(filteredTeamMetrics).forEach(member => {
                            if (member.wip_by_state) {
                                Object.entries(member.wip_by_state).forEach(([state, count]) => {
                                    wipByState[state] = (wipByState[state] || 0) + count;
                                });
                            }
                        });
                    }
                }

                if (Object.keys(wipByState).length === 0) {
                    document.getElementById('workDistributionChart').innerHTML = '<p class="text-center text-muted mt-5">No work distribution data available</p>';
                    return;
                }

                const chartData = [{
                    labels: Object.keys(wipByState),
                    values: Object.values(wipByState),
                    type: 'pie',
                    hole: 0.5,
                    marker: {
                        colors: ['#3498db', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6']
                    },
                    textinfo: 'label+percent',
                    textposition: 'outside'
                }];

                const layout = {
                    margin: { l: 20, r: 20, t: 20, b: 20 },
                    showlegend: true,
                    legend: { orientation: 'h', y: -0.1 }
                };

                Plotly.newPlot('workDistributionChart', chartData, layout, { responsive: true });
            }

            updateThroughputChart(data) {
                const summary = data.summary || {};
                const throughput = data.throughput || {};
                let teamMetrics = data.team_metrics || {};

                // Apply workstream filtering to throughput data
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);

                let actualThroughput = throughput.items_per_period || 20;
                
                // If workstream filtering is active, calculate filtered throughput
                if (!this.selectedWorkstreams.includes('All Teams') && Object.keys(teamMetrics).length > 0) {
                    const filteredCompleted = Object.values(teamMetrics).reduce((sum, member) => sum + (member.completed_items || 0), 0);
                    actualThroughput = filteredCompleted / (throughput.period_days || 30) * 30; // Monthly rate
                }

                // Generate throughput trend based on actual or filtered data
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                const throughputData = months.map((month, index) => {
                    // Simulate trend around actual throughput with some variation
                    const variation = (Math.random() - 0.5) * 0.3; // ±15% variation
                    const trendFactor = 1 + (index * 0.05); // 5% growth per month
                    return Math.max(5, actualThroughput * trendFactor * (1 + variation));
                });

                const chartData = [{
                    x: months,
                    y: throughputData,
                    type: 'bar',
                    marker: {
                        color: '#3498db',
                        opacity: 0.8
                    },
                    text: throughputData.map(val => val.toFixed(0)),
                    textposition: 'auto'
                }];

                const layout = {
                    margin: { l: 60, r: 40, t: 20, b: 60 },
                    xaxis: { title: 'Month' },
                    yaxis: { title: 'Items Delivered' }
                };

                Plotly.newPlot('throughputChart', chartData, layout, { responsive: true });
            }

            updateTeamOverview(data) {
                let teamMetrics = data.team_metrics || {};
                const summary = data.summary || {};
                const leadTime = data.lead_time || {};

                // Apply workstream filtering
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);

                const teamSize = Object.keys(teamMetrics).length;
                let totalCompletionRate = 0;
                let activeMembers = 0;

                Object.values(teamMetrics).forEach(member => {
                    if (member.completion_rate) {
                        totalCompletionRate += member.completion_rate;
                        activeMembers++;
                    }
                });

                const avgCompletionRate = activeMembers > 0 ? totalCompletionRate / activeMembers : 0;
                const teamUtilization = Math.min(100, (summary.completed_items || 0) / (summary.total_work_items || 1) * 100);

                document.getElementById('totalTeamSize').textContent = teamSize || '--';
                document.getElementById('avgCompletionRate').textContent = avgCompletionRate ? `${avgCompletionRate.toFixed(1)}%` : '--%';
                document.getElementById('avgLeadTime').textContent = leadTime.average_days ? `${leadTime.average_days.toFixed(1)} days` : '-- days';
                document.getElementById('teamUtilization').textContent = `${teamUtilization.toFixed(1)}%`;
            }

            generateExecutiveMockData() {
                // Enhanced mock data for executive dashboard
                return {
                    summary: {
                        total_work_items: 250,
                        completed_items: 187,
                        completion_rate: 74.8
                    },
                    lead_time: {
                        average_days: 12.4,
                        median_days: 10.0,
                        count: 187
                    },
                    cycle_time: {
                        average_days: 8.7,
                        median_days: 7.5,
                        count: 187
                    },
                    throughput: {
                        items_per_period: 23.4,
                        period_days: 30
                    },
                    work_in_progress: {
                        total_wip: 63,
                        wip_by_state: {
                            "Analysis": 8,
                            "Development": 24,
                            "Testing": 18,
                            "Review": 13
                        }
                    },
                    flow_efficiency: {
                        average_efficiency: 0.73
                    },
                    team_metrics: {
                        "Engineering Team Alpha": { completed_items: 45, active_items: 8, completion_rate: 89.2, average_lead_time: 9.8 },
                        "Engineering Team Beta": { completed_items: 38, active_items: 6, completion_rate: 84.7, average_lead_time: 11.2 },
                        "QA Team": { completed_items: 52, active_items: 12, completion_rate: 78.5, average_lead_time: 15.3 },
                        "DevOps Team": { completed_items: 28, active_items: 4, completion_rate: 91.3, average_lead_time: 8.1 },
                        "Product Team": { completed_items: 24, active_items: 7, completion_rate: 77.4, average_lead_time: 13.6 }
                    },
                    // Enhanced mock data for executive dashboard
                    items_by_type: {
                        "User Story": 125,
                        "Bug": 32,
                        "Task": 68,
                        "Feature": 18,
                        "Epic": 7
                    },
                    items_by_sprint: {
                        "Sprint 24.1": 45,
                        "Sprint 24.2": 52,
                        "Sprint 24.3": 48,
                        "Sprint 24.4": 38,
                        "Backlog": 17
                    },
                    sprints: ["Sprint 24.1", "Sprint 24.2", "Sprint 24.3", "Sprint 24.4", "Backlog"]
                };
            }

            showNoDataMessage() {
                document.getElementById('deliverySpeed').textContent = '--';
                document.getElementById('flowEfficiency').textContent = '--%';
                document.getElementById('wipItems').textContent = '--';
                document.getElementById('teamVelocity').textContent = '--';
            }

            showErrorMessage(message) {
                this.updateDataSourceInfo('Error: ' + message);
            }

            handleWorkstreamFilter(event) {
                event.preventDefault();
                const target = event.target.closest('[data-workstream]');
                if (!target) return;

                const workstream = target.getAttribute('data-workstream');
                const checkbox = target.querySelector('input[type="checkbox"]');

                if (workstream === 'All Teams') {
                    // Toggle all workstreams
                    if (checkbox.checked) {
                        this.selectedWorkstreams = ['All Teams'];
                        // Uncheck all other checkboxes
                        document.querySelectorAll('#workstreamDropdownMenu input[type="checkbox"]').forEach(cb => {
                            cb.checked = cb.closest('[data-workstream]').getAttribute('data-workstream') === 'All Teams';
                        });
                    } else {
                        checkbox.checked = true; // Keep All Teams checked if trying to uncheck
                        return;
                    }
                } else {
                    // Toggle specific workstream
                    const allTeamsCheckbox = document.querySelector('[data-workstream="All Teams"] input');

                    if (checkbox.checked) {
                        // Add to selection
                        if (this.selectedWorkstreams.includes('All Teams')) {
                            this.selectedWorkstreams = [workstream];
                            allTeamsCheckbox.checked = false;
                        } else if (!this.selectedWorkstreams.includes(workstream)) {
                            this.selectedWorkstreams.push(workstream);
                        }
                    } else {
                        // Remove from selection
                        this.selectedWorkstreams = this.selectedWorkstreams.filter(w => w !== workstream);
                        if (this.selectedWorkstreams.length === 0) {
                            // If no workstreams selected, default to All Teams
                            this.selectedWorkstreams = ['All Teams'];
                            allTeamsCheckbox.checked = true;
                        }
                    }
                }

                this.updateWorkstreamDisplay();
                this.updateExecutiveDashboard(this.data);
            }

            updateWorkstreamDisplay() {
                const button = document.getElementById('workstreamDropdown');
                const info = document.getElementById('workstreamInfo');

                if (this.selectedWorkstreams.includes('All Teams')) {
                    button.innerHTML = '<i class="fas fa-chart-pie me-2"></i>All Workstreams';
                    info.textContent = 'All workstreams included';
                } else if (this.selectedWorkstreams.length === 1) {
                    button.innerHTML = `<i class="fas fa-chart-pie me-2"></i>${this.selectedWorkstreams[0]} Focus`;
                    info.textContent = `Executive view focused on ${this.selectedWorkstreams[0]} workstream`;
                } else {
                    button.innerHTML = `<i class="fas fa-chart-pie me-2"></i>${this.selectedWorkstreams.length} Workstreams`;
                    info.textContent = `Executive view of ${this.selectedWorkstreams.length} workstreams: ${this.selectedWorkstreams.join(', ')}`;
                }
            }
        }

        // Initialize executive dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new ExecutiveDashboard();
        });
    </script>
</body>
</html>
