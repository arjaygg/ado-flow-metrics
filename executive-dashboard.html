<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Metrics Executive Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="js/workstream_config.js"></script>
    <script src="js/workstream-manager.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        .executive-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }

        .kpi-card.success { border-left-color: var(--success-color); }
        .kpi-card.warning { border-left-color: var(--warning-color); }
        .kpi-card.danger { border-left-color: var(--danger-color); }
        .kpi-card.info { border-left-color: var(--info-color); }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }

        .kpi-label {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #7f8c8d;
        }

        .kpi-trend {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }
        .trend-stable { color: var(--info-color); }

        .chart-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #ecf0f1;
        }

        .data-source-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .executive-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .benchmark-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .benchmark-excellent { background-color: var(--success-color); }
        .benchmark-good { background-color: var(--info-color); }
        .benchmark-needs-improvement { background-color: var(--warning-color); }
        .benchmark-critical { background-color: var(--danger-color); }

        /* Work Items Table Styles */
        .table-responsive {
            max-height: 600px;
        }
        
        .table th {
            position: sticky;
            top: 0;
            z-index: 10;
            border-top: none;
        }
        
        .work-item-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .work-item-link:hover {
            color: var(--info-color);
            text-decoration: underline;
        }
        
        .workstream-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .workstream-data { background-color: #e3f2fd; color: #0d47a1; }
        .workstream-qa { background-color: #f3e5f5; color: #4a148c; }
        .workstream-outsystems { background-color: #e8f5e8; color: #1b5e20; }
        .workstream-others { background-color: #fafafa; color: #424242; }
        
        .priority-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .priority-1 { background-color: #ffebee; color: #c62828; }
        .priority-2 { background-color: #fff3e0; color: #ef6c00; }
        .priority-3 { background-color: #f3e5f5; color: #7b1fa2; }
        .priority-4 { background-color: #e8f5e8; color: #388e3c; }
        
        .state-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .state-new { background-color: #f5f5f5; color: #616161; }
        .state-active { background-color: #e3f2fd; color: #1976d2; }
        .state-resolved { background-color: #e8f5e8; color: #388e3c; }
        .state-closed { background-color: #fce4ec; color: #c2185b; }
        
        .chart-clickable {
            cursor: pointer;
        }
        
        .chart-clickable:hover {
            opacity: 0.8;
        }
        
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            border: 1px solid transparent;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background-color: white;
            border-color: #dee2e6 #dee2e6 white;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Executive Header -->
    <div class="executive-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-chart-line me-3"></i>Flow Metrics Executive Dashboard
                    </h1>
                    <p class="mb-0 opacity-75">Team Performance & Delivery Insights</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-light me-2" id="refreshBtn">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                    <button class="btn btn-light" id="loadDataBtn">
                        <i class="fas fa-upload me-2"></i>Load Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Tab Navigation -->
        <div class="row mb-3">
            <div class="col-12">
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="nav-overview-tab" data-bs-toggle="tab" data-bs-target="#nav-overview" type="button" role="tab" aria-controls="nav-overview" aria-selected="true">
                            <i class="fas fa-chart-pie me-2"></i>Executive Overview
                        </button>
                        <button class="nav-link" id="nav-workitems-tab" data-bs-toggle="tab" data-bs-target="#nav-workitems" type="button" role="tab" aria-controls="nav-workitems" aria-selected="false">
                            <i class="fas fa-list-ul me-2"></i>Work Items Details
                        </button>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="nav-tabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="nav-overview" role="tabpanel" aria-labelledby="nav-overview-tab">
                <!-- Data Source Panel -->
        <div class="data-source-panel">
            <div class="row align-items-center mb-3">
                <div class="col-md-6">
                    <h6 class="mb-1"><i class="fas fa-database me-2"></i>Data Source</h6>
                    <small class="text-muted" id="dataSourceInfo">Select data source to begin</small>
                </div>
                <div class="col-md-6">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="dataSource" id="mockData">
                        <label class="btn btn-outline-primary" for="mockData">Demo Data</label>

                        <input type="radio" class="btn-check" name="dataSource" id="jsonFile">
                        <label class="btn btn-outline-primary" for="jsonFile">Upload Report</label>

                        <input type="radio" class="btn-check" name="dataSource" id="indexedDB">
                        <label class="btn btn-outline-primary" for="indexedDB">Saved Data</label>

                        <input type="radio" class="btn-check" name="dataSource" id="cliData" checked>
                        <label class="btn btn-outline-primary" for="cliData">CLI Data</label>
                    </div>
                </div>
            </div>
            <!-- Executive Workstream Filter -->
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-1"><i class="fas fa-project-diagram me-2"></i>Workstream Focus</h6>
                    <small class="text-muted" id="workstreamInfo">All workstreams included</small>
                </div>
                <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="workstreamDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-chart-pie me-2"></i>All Workstreams
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="workstreamDropdown" id="workstreamDropdownMenu">
                            <li><a class="dropdown-item" href="#" data-workstream="All Teams">
                                <input type="checkbox" class="form-check-input me-2" checked> All Workstreams
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <!-- Workstream options will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="executive-summary">
            <h4 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Executive Summary</h4>
            <div class="row">
                <div class="col-md-8">
                    <p class="mb-2" id="summaryText">Loading executive summary...</p>
                    <div class="mt-3">
                        <h6>Key Insights:</h6>
                        <ul id="keyInsights" class="mb-0">
                            <li>Loading insights...</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <h6>Performance Benchmarks</h6>
                    <div class="mt-2">
                        <div><span class="benchmark-indicator benchmark-excellent"></span>Excellent (Top 25%)</div>
                        <div><span class="benchmark-indicator benchmark-good"></span>Good (Average)</div>
                        <div><span class="benchmark-indicator benchmark-needs-improvement"></span>Needs Improvement</div>
                        <div><span class="benchmark-indicator benchmark-critical"></span>Critical</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Performance Indicators -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">Delivery Speed</div>
                            <div class="kpi-value text-primary" id="deliverySpeed">--</div>
                            <div class="kpi-trend" id="deliveryTrend">
                                <i class="fas fa-minus"></i> No trend data
                            </div>
                        </div>
                        <div class="text-primary opacity-25">
                            <i class="fas fa-tachometer-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card success">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">Flow Efficiency</div>
                            <div class="kpi-value text-success" id="flowEfficiency">--%</div>
                            <div class="kpi-trend" id="efficiencyTrend">
                                <i class="fas fa-minus"></i> No trend data
                            </div>
                        </div>
                        <div class="text-success opacity-25">
                            <i class="fas fa-stream fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card warning">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">Work in Progress</div>
                            <div class="kpi-value text-warning" id="wipItems">--</div>
                            <div class="kpi-trend" id="wipTrend">
                                <i class="fas fa-minus"></i> No trend data
                            </div>
                        </div>
                        <div class="text-warning opacity-25">
                            <i class="fas fa-tasks fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card info">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="kpi-label">Team Velocity</div>
                            <div class="kpi-value text-info" id="teamVelocity">--</div>
                            <div class="kpi-trend" id="velocityTrend">
                                <i class="fas fa-minus"></i> No trend data
                            </div>
                        </div>
                        <div class="text-info opacity-25">
                            <i class="fas fa-rocket fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1: Delivery Performance -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-area me-2"></i>Delivery Performance Trends
                    </h5>
                    <div id="deliveryTrendsChart" style="height: 350px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-gauge me-2"></i>Flow Efficiency Score
                    </h5>
                    <div id="efficiencyGauge" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2: Capacity & Flow -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-project-diagram me-2"></i>Work Distribution
                    </h5>
                    <div id="workDistributionChart" style="height: 300px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-bar me-2"></i>Throughput Analysis
                    </h5>
                    <div id="throughputChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Team Capacity Overview -->
        <div class="row">
            <div class="col-12">
                <div class="chart-section">
                    <h5 class="chart-title">
                        <i class="fas fa-users me-2"></i>Team Capacity & Performance Overview
                    </h5>
                    <div class="row" id="teamOverview">
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <h4 class="text-primary mb-1" id="totalTeamSize">--</h4>
                                <small class="text-muted">Team Members</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <h4 class="text-success mb-1" id="avgCompletionRate">--%</h4>
                                <small class="text-muted">Avg Completion Rate</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <h4 class="text-info mb-1" id="avgLeadTime">-- days</h4>
                                <small class="text-muted">Avg Lead Time</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3">
                                <h4 class="text-warning mb-1" id="teamUtilization">--%</h4>
                                <small class="text-muted">Team Utilization</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
            <!-- End Overview Tab -->

            <!-- Work Items Tab -->
            <div class="tab-pane fade" id="nav-workitems" role="tabpanel" aria-labelledby="nav-workitems-tab">
                <!-- Work Items Data Source Info -->
                <div class="data-source-panel">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-8">
                            <h6 class="mb-1"><i class="fas fa-list-ul me-2"></i>Work Items Details</h6>
                            <small class="text-muted" id="workItemsInfo">Work items matching current filters</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-secondary btn-sm" id="exportWorkItemsBtn">
                                    <i class="fas fa-download me-2"></i>Export CSV
                                </button>
                                <button class="btn btn-outline-primary btn-sm" id="refreshWorkItemsBtn">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Filter Summary -->
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">Workstream Filter: <span id="workItemsFilterSummary">All Workstreams</span></small>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">Total Items: <span id="workItemsCount">--</span></small>
                        </div>
                    </div>
                </div>

                <!-- Work Items Table -->
                <div class="chart-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="chart-title mb-0">
                            <i class="fas fa-table me-2"></i>Work Items Table
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="tableView" id="allItemsView" checked>
                            <label class="btn btn-outline-primary" for="allItemsView">All Items</label>
                            <input type="radio" class="btn-check" name="tableView" id="completedItemsView">
                            <label class="btn btn-outline-success" for="completedItemsView">Completed</label>
                            <input type="radio" class="btn-check" name="tableView" id="activeItemsView">
                            <label class="btn btn-outline-warning" for="activeItemsView">In Progress</label>
                        </div>
                    </div>
                    
                    <!-- Table Container -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="workItemsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 8%">ID</th>
                                    <th style="width: 25%">Title</th>
                                    <th style="width: 10%">Type</th>
                                    <th style="width: 10%">State</th>
                                    <th style="width: 12%">Assigned To</th>
                                    <th style="width: 10%">Workstream</th>
                                    <th style="width: 8%">Priority</th>
                                    <th style="width: 10%">Created</th>
                                    <th style="width: 7%">Action</th>
                                </tr>
                            </thead>
                            <tbody id="workItemsTableBody">
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading work items...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Work items pagination" class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center" id="workItemsPagination">
                            <!-- Pagination will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
            <!-- End Work Items Tab -->
        </div>
        <!-- End Tab Content -->
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Executive Flow Metrics Dashboard
        class ExecutiveDashboard {
            static ITEMS_PER_PAGE = 50;
            static ADO_BASE_URL = 'https://dev.azure.com'; // This should be configurable
            constructor() {
                this.data = null;
                this.dbName = 'FlowMetricsExecutiveDB';
                this.dbVersion = 1;
                this.db = null;
                this.workstreamManager = new WorkstreamManager();
                this.selectedWorkstreams = ['All Teams'];
                this.currentWorkItems = [];
                this.filteredWorkItems = [];
                this.currentPage = 1;
                this.selectedTableView = 'allItemsView';
                this.drilldownFilter = null;
                this.init();
            }

            async loadConfig() {
                try {
                    const response = await fetch('./config/config.json');
                    if (!response.ok) {
                        throw new Error(`Failed to load config: ${response.status}`);
                    }
                    this.config = await response.json();
                    console.log('Config loaded:', this.config);
                } catch (error) {
                    console.error('Failed to load configuration:', error);
                    // Fallback to default config
                    this.config = {
                        azure_devops: {
                            org_url: 'https://dev.azure.com/example-org',
                            default_project: 'example-project'
                        }
                    };
                }
            }

            async init() {
                await this.loadConfig();
                await this.initIndexedDB();
                await this.initWorkstreams();
                this.setupEventListeners();
                this.loadData();
            }

            async initWorkstreams() {
                try {
                    await this.workstreamManager.init();
                    this.populateWorkstreamFilter();
                    console.log('Executive workstream filtering initialized');
                } catch (error) {
                    console.error('Failed to initialize executive workstream filtering:', error);
                }
            }

            populateWorkstreamFilter() {
                const menu = document.getElementById('workstreamDropdownMenu');
                const workstreams = this.workstreamManager.getAvailableWorkstreams();

                // Clear existing workstream items (keep All Teams)
                const existingItems = menu.querySelectorAll('[data-workstream]:not([data-workstream="All Teams"])');
                existingItems.forEach(item => item.parentElement.remove());

                // Add workstream options
                workstreams.forEach(workstream => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a class="dropdown-item" href="#" data-workstream="${workstream}">
                            <input type="checkbox" class="form-check-input me-2"> ${workstream}
                        </a>
                    `;
                    menu.appendChild(li);
                });
            }

            async initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('executive_metrics')) {
                            const store = db.createObjectStore('executive_metrics', { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };
                });
            }

            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadData());
                document.getElementById('loadDataBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileLoad(e));
                document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                    radio.addEventListener('change', () => this.loadData());
                });

                // Workstream filter
                document.getElementById('workstreamDropdownMenu').addEventListener('click', (e) => {
                    this.handleWorkstreamFilter(e);
                });
            }

            async loadData() {
                const selectedSource = document.querySelector('input[name="dataSource"]:checked').id;

                try {
                    let data = null;

                    switch (selectedSource) {
                        case 'mockData':
                            data = this.generateExecutiveMockData();
                            this.updateDataSourceInfo('Executive demo data loaded');
                            break;
                        case 'jsonFile':
                            data = this.data;
                            this.updateDataSourceInfo(data ? 'Report file loaded' : 'No report file loaded');
                            break;
                        case 'indexedDB':
                            data = await this.loadFromIndexedDB();
                            this.updateDataSourceInfo(data ? 'Data loaded from browser storage' : 'No saved data found');
                            break;
                        case 'cliData':
                            data = await this.loadFromCLI();
                            this.updateDataSourceInfo(data ? 'CLI data loaded successfully' : 'No CLI data available');
                            break;
                    }

                    if (data) {
                        this.data = data;
                        this.extractWorkItems(data);
                        this.updateExecutiveDashboard(data);

                        if (selectedSource !== 'indexedDB') {
                            await this.saveToIndexedDB(data);
                        }
                    } else {
                        this.showNoDataMessage();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showErrorMessage(error.message);
                }
            }

            handleFileLoad(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.data = data;
                        document.getElementById('jsonFile').checked = true;
                        this.updateDataSourceInfo(`Report: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
                        this.updateExecutiveDashboard(data);
                        this.saveToIndexedDB(data);
                    } catch (error) {
                        alert('Error parsing report file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            async saveToIndexedDB(data) {
                const transaction = this.db.transaction(['executive_metrics'], 'readwrite');
                const store = transaction.objectStore('executive_metrics');
                await store.put({
                    id: 'latest',
                    timestamp: new Date().toISOString(),
                    data: data
                });
            }

            async loadFromIndexedDB() {
                const transaction = this.db.transaction(['executive_metrics'], 'readonly');
                const store = transaction.objectStore('executive_metrics');
                return new Promise((resolve) => {
                    const request = store.get('latest');
                    request.onsuccess = () => resolve(request.result ? request.result.data : null);
                    request.onerror = () => resolve(null);
                });
            }

            // Load data from CLI-generated files
            async loadFromCLI() {
                try {
                    // Try multiple CLI data locations
                    const dataSources = [
                        './data/dashboard_data.json',
                        './data/flow_metrics_report.json',
                        './data/test_report.json',
                        './data/test_metrics_report.json'
                    ];

                    let metricsData = null;
                    let workItemsData = null;

                    // Load metrics data
                    for (const source of dataSources) {
                        try {
                            const response = await fetch(source);
                            if (response.ok) {
                                const data = await response.json();
                                console.log(`Successfully loaded executive data from ${source}`);

                                // Handle different data formats
                                if (data.data) {
                                    metricsData = data.data; // Dashboard format
                                    break;
                                } else if (data.summary || data.lead_time || data.cycle_time) {
                                    metricsData = data; // Direct metrics format
                                    break;
                                }
                            }
                        } catch (err) {
                            console.log(`Failed to load from ${source}: ${err.message}`);
                        }
                    }

                    // Try to load work items data - prefer real ADO data
                    const workItemsSources = [
                        './data/work_items_ado.json',  // Real ADO data
                        './data/work_items.json'        // Fallback
                    ];
                    
                    for (const source of workItemsSources) {
                        try {
                            const workItemsResponse = await fetch(source);
                            if (workItemsResponse.ok) {
                                workItemsData = await workItemsResponse.json();
                                console.log(`Successfully loaded work items data from ${source}`);
                                break;
                            }
                        } catch (err) {
                            console.log(`Failed to load work items from ${source}: ${err.message}`);
                        }
                    }

                    // Combine the data
                    if (metricsData) {
                        if (workItemsData && Array.isArray(workItemsData)) {
                            // Add work items to metrics data
                            metricsData.work_items = workItemsData;
                        }
                        return metricsData;
                    }

                    console.log('No CLI data found in any location');
                    return null;
                } catch (error) {
                    console.log('CLI data loading error:', error.message);
                    return null;
                }
            }

            updateDataSourceInfo(message) {
                document.getElementById('dataSourceInfo').textContent = message + ' â€¢ ' + new Date().toLocaleTimeString();
            }

            updateExecutiveDashboard(data) {
                this.updateExecutiveSummary(data);
                this.updateKPIs(data);
                this.updateCharts(data);
                this.updateTeamOverview(data);
                this.enableChartDrilldown();
            }

            updateExecutiveSummary(data) {
                const summary = data.summary || {};
                const leadTime = data.lead_time || {};
                const efficiency = data.flow_efficiency || {};
                const wip = data.work_in_progress || {};
                let teamMetrics = data.team_metrics || {};

                // Apply workstream filtering for summary calculations
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);
                const filteredTeamSize = Object.keys(teamMetrics).length;

                // Calculate filtered metrics
                let filteredCompleted = 0;
                let filteredActive = 0;
                Object.values(teamMetrics).forEach(member => {
                    filteredCompleted += member.completed_items || 0;
                    filteredActive += member.active_items || 0;
                });

                const totalFiltered = filteredCompleted + filteredActive;
                const filteredCompletionRate = totalFiltered > 0 ? (filteredCompleted / totalFiltered) * 100 : 0;

                // Executive summary text with workstream context
                let summaryText;
                if (this.selectedWorkstreams.includes('All Teams')) {
                    summaryText = `Team delivered ${summary.completed_items || 0} items out of ${summary.total_work_items || 0} total items (${(summary.completion_rate || 0).toFixed(1)}% completion rate). Average delivery time is ${(leadTime.average_days || 0).toFixed(1)} days with ${((efficiency.average_efficiency || 0) * 100).toFixed(1)}% flow efficiency.`;
                } else {
                    const workstreamNames = this.selectedWorkstreams.join(', ');
                    summaryText = `${workstreamNames} workstream(s) with ${filteredTeamSize} team members delivered ${filteredCompleted} items with ${filteredCompletionRate.toFixed(1)}% completion rate. Average delivery time is ${(leadTime.average_days || 0).toFixed(1)} days with ${((efficiency.average_efficiency || 0) * 100).toFixed(1)}% flow efficiency.`;
                }

                document.getElementById('summaryText').textContent = summaryText;

                // Key insights
                const insights = this.generateExecutiveInsights(data);
                const insightsList = document.getElementById('keyInsights');
                insightsList.innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
            }

            generateExecutiveInsights(data) {
                const insights = [];
                const leadTime = data.lead_time || {};
                const efficiency = data.flow_efficiency || {};
                const throughput = data.throughput || {};
                const wip = data.work_in_progress || {};

                // Lead time insights
                if (leadTime.average_days < 10) {
                    insights.push('ðŸŸ¢ Excellent delivery speed - under 10 days average lead time');
                } else if (leadTime.average_days > 20) {
                    insights.push('ðŸ”´ Delivery speed needs attention - over 20 days average lead time');
                } else {
                    insights.push('ðŸŸ¡ Moderate delivery speed - room for improvement');
                }

                // Flow efficiency insights
                const efficiencyPercent = (efficiency.average_efficiency || 0) * 100;
                if (efficiencyPercent > 70) {
                    insights.push('ðŸŸ¢ High flow efficiency - minimal waste in process');
                } else if (efficiencyPercent < 40) {
                    insights.push('ðŸ”´ Low flow efficiency - significant process bottlenecks detected');
                } else {
                    insights.push('ðŸŸ¡ Moderate flow efficiency - optimization opportunities exist');
                }

                // WIP insights
                if (wip.total_wip > 100) {
                    insights.push('ðŸ”´ High work in progress - may impact delivery speed');
                } else if (wip.total_wip < 30) {
                    insights.push('ðŸŸ¢ Well-managed work in progress levels');
                } else {
                    insights.push('ðŸŸ¡ Moderate WIP levels - monitor for trends');
                }

                // Throughput insights
                if (throughput.items_per_period > 25) {
                    insights.push('ðŸŸ¢ Strong team velocity - high throughput achieved');
                } else if (throughput.items_per_period < 10) {
                    insights.push('ðŸ”´ Low team velocity - capacity constraints detected');
                }

                return insights;
            }

            updateKPIs(data) {
                const leadTime = data.lead_time || {};
                const efficiency = data.flow_efficiency || {};
                const throughput = data.throughput || {};
                const wip = data.work_in_progress || {};
                let teamMetrics = data.team_metrics || {};

                // Apply workstream filtering to team metrics for KPI calculations
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);

                // If workstream filtering is active, recalculate KPIs from filtered data
                if (!this.selectedWorkstreams.includes('All Teams') && Object.keys(teamMetrics).length > 0) {
                    // Calculate filtered metrics
                    let filteredCompleted = 0;
                    let filteredActive = 0;
                    let totalLeadTime = 0;
                    let leadTimeCount = 0;

                    Object.values(teamMetrics).forEach(member => {
                        filteredCompleted += member.completed_items || 0;
                        filteredActive += member.active_items || 0;
                        if (member.average_lead_time) {
                            totalLeadTime += member.average_lead_time;
                            leadTimeCount++;
                        }
                    });

                    const filteredAvgLeadTime = leadTimeCount > 0 ? totalLeadTime / leadTimeCount : (leadTime.average_days || 0);
                    const filteredThroughput = filteredCompleted > 0 ? (filteredCompleted / 30) : (throughput.items_per_period || 0);
                    const filteredWip = filteredActive;

                    // Update KPIs with filtered data
                    document.getElementById('deliverySpeed').textContent = `${filteredAvgLeadTime.toFixed(1)} days`;
                    document.getElementById('flowEfficiency').textContent = `${((efficiency.average_efficiency || 0) * 100).toFixed(1)}%`;
                    document.getElementById('wipItems').textContent = filteredWip;
                    document.getElementById('teamVelocity').textContent = `${filteredThroughput.toFixed(1)}/mo`;
                } else {
                    // Use original aggregate data for "All Teams"
                    document.getElementById('deliverySpeed').textContent = `${(leadTime.average_days || 0).toFixed(1)} days`;
                    document.getElementById('flowEfficiency').textContent = `${((efficiency.average_efficiency || 0) * 100).toFixed(1)}%`;
                    document.getElementById('wipItems').textContent = wip.total_wip || 0;
                    document.getElementById('teamVelocity').textContent = `${(throughput.items_per_period || 0).toFixed(1)}/mo`;
                }

                // Add trend indicators (simplified for demo)
                this.updateTrendIndicator('deliveryTrend', 'stable');
                this.updateTrendIndicator('efficiencyTrend', 'up');
                this.updateTrendIndicator('wipTrend', 'down');
                this.updateTrendIndicator('velocityTrend', 'up');
            }

            updateTrendIndicator(elementId, trend) {
                const element = document.getElementById(elementId);
                const trends = {
                    'up': { icon: 'fa-arrow-up', class: 'trend-up', text: 'Improving' },
                    'down': { icon: 'fa-arrow-down', class: 'trend-down', text: 'Declining' },
                    'stable': { icon: 'fa-minus', class: 'trend-stable', text: 'Stable' }
                };

                const trendData = trends[trend];
                element.innerHTML = `<i class="fas ${trendData.icon}"></i> ${trendData.text}`;
                element.className = `kpi-trend ${trendData.class}`;
            }

            updateCharts(data) {
                this.updateDeliveryTrendsChart(data);
                this.updateEfficiencyGauge(data);
                this.updateWorkDistributionChart(data);
                this.updateThroughputChart(data);
            }

            updateDeliveryTrendsChart(data) {
                // Simulate trend data
                const days = 30;
                const leadTimeData = [];
                const cycleTimeData = [];

                for (let i = days; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);

                    leadTimeData.push({
                        x: date.toISOString().split('T')[0],
                        y: Math.random() * 5 + 8 // 8-13 days
                    });

                    cycleTimeData.push({
                        x: date.toISOString().split('T')[0],
                        y: Math.random() * 4 + 6 // 6-10 days
                    });
                }

                const chartData = [
                    {
                        x: leadTimeData.map(d => d.x),
                        y: leadTimeData.map(d => d.y),
                        name: 'Lead Time',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#3498db', width: 3 },
                        marker: { size: 6 }
                    },
                    {
                        x: cycleTimeData.map(d => d.x),
                        y: cycleTimeData.map(d => d.y),
                        name: 'Cycle Time',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#27ae60', width: 3 },
                        marker: { size: 6 }
                    }
                ];

                const layout = {
                    margin: { l: 60, r: 40, t: 20, b: 60 },
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Days' },
                    showlegend: true,
                    legend: { x: 0, y: 1 }
                };

                Plotly.newPlot('deliveryTrendsChart', chartData, layout, { responsive: true });
            }

            updateEfficiencyGauge(data) {
                const efficiency = data.flow_efficiency || {};
                let value = (efficiency.average_efficiency || 0) * 100;

                // Apply workstream filtering to efficiency calculation
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    const filteredTeamMetrics = this.workstreamManager.filterTeamMetrics(data.team_metrics || {}, this.selectedWorkstreams);
                    
                    if (Object.keys(filteredTeamMetrics).length > 0) {
                        // Recalculate efficiency for filtered teams
                        const efficiencyValues = Object.values(filteredTeamMetrics)
                            .map(member => member.flow_efficiency || member.efficiency || 0)
                            .filter(eff => eff > 0);
                        
                        if (efficiencyValues.length > 0) {
                            const avgEfficiency = efficiencyValues.reduce((sum, eff) => sum + eff, 0) / efficiencyValues.length;
                            value = avgEfficiency * 100;
                        }
                    }
                }

                const chartData = [{
                    domain: { x: [0, 1], y: [0, 1] },
                    value: value,
                    title: { text: "Flow Efficiency %" },
                    type: "indicator",
                    mode: "gauge+number",
                    gauge: {
                        axis: { range: [null, 100] },
                        bar: { color: value > 70 ? "#27ae60" : value > 40 ? "#f39c12" : "#e74c3c" },
                        steps: [
                            { range: [0, 40], color: "#ecf0f1" },
                            { range: [40, 70], color: "#f8f9fa" },
                            { range: [70, 100], color: "#e8f5e8" }
                        ],
                        threshold: {
                            line: { color: "#2c3e50", width: 4 },
                            thickness: 0.75,
                            value: 70
                        }
                    }
                }];

                const layout = {
                    margin: { l: 20, r: 20, t: 20, b: 20 }
                };

                Plotly.newPlot('efficiencyGauge', chartData, layout, { responsive: true });
            }

            updateWorkDistributionChart(data) {
                const wip = data.work_in_progress || {};
                let wipByState = wip.wip_by_state || {};

                // Apply workstream filtering to WIP data
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    const filteredTeamMetrics = this.workstreamManager.filterTeamMetrics(data.team_metrics || {}, this.selectedWorkstreams);
                    
                    if (Object.keys(filteredTeamMetrics).length > 0) {
                        // Recalculate WIP by state for filtered teams
                        wipByState = {};
                        Object.values(filteredTeamMetrics).forEach(member => {
                            if (member.wip_by_state) {
                                Object.entries(member.wip_by_state).forEach(([state, count]) => {
                                    wipByState[state] = (wipByState[state] || 0) + count;
                                });
                            }
                        });
                    }
                }

                if (Object.keys(wipByState).length === 0) {
                    document.getElementById('workDistributionChart').innerHTML = '<p class="text-center text-muted mt-5">No work distribution data available</p>';
                    return;
                }

                const chartData = [{
                    labels: Object.keys(wipByState),
                    values: Object.values(wipByState),
                    type: 'pie',
                    hole: 0.5,
                    marker: {
                        colors: ['#3498db', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6']
                    },
                    textinfo: 'label+percent',
                    textposition: 'outside'
                }];

                const layout = {
                    margin: { l: 20, r: 20, t: 20, b: 20 },
                    showlegend: true,
                    legend: { orientation: 'h', y: -0.1 }
                };

                Plotly.newPlot('workDistributionChart', chartData, layout, { responsive: true });
            }

            updateThroughputChart(data) {
                const summary = data.summary || {};
                const throughput = data.throughput || {};
                let teamMetrics = data.team_metrics || {};

                // Apply workstream filtering to throughput data
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);

                let actualThroughput = throughput.items_per_period || 20;
                
                // If workstream filtering is active, calculate filtered throughput
                if (!this.selectedWorkstreams.includes('All Teams') && Object.keys(teamMetrics).length > 0) {
                    const filteredCompleted = Object.values(teamMetrics).reduce((sum, member) => sum + (member.completed_items || 0), 0);
                    actualThroughput = filteredCompleted / (throughput.period_days || 30) * 30; // Monthly rate
                }

                // Generate throughput trend based on actual or filtered data
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                const throughputData = months.map((month, index) => {
                    // Simulate trend around actual throughput with some variation
                    const variation = (Math.random() - 0.5) * 0.3; // Â±15% variation
                    const trendFactor = 1 + (index * 0.05); // 5% growth per month
                    return Math.max(5, actualThroughput * trendFactor * (1 + variation));
                });

                const chartData = [{
                    x: months,
                    y: throughputData,
                    type: 'bar',
                    marker: {
                        color: '#3498db',
                        opacity: 0.8
                    },
                    text: throughputData.map(val => val.toFixed(0)),
                    textposition: 'auto'
                }];

                const layout = {
                    margin: { l: 60, r: 40, t: 20, b: 60 },
                    xaxis: { title: 'Month' },
                    yaxis: { title: 'Items Delivered' }
                };

                Plotly.newPlot('throughputChart', chartData, layout, { responsive: true });
            }

            updateTeamOverview(data) {
                let teamMetrics = data.team_metrics || {};
                const summary = data.summary || {};
                const leadTime = data.lead_time || {};

                // Apply workstream filtering
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);

                const teamSize = Object.keys(teamMetrics).length;
                let totalCompletionRate = 0;
                let activeMembers = 0;

                Object.values(teamMetrics).forEach(member => {
                    if (member.completion_rate) {
                        totalCompletionRate += member.completion_rate;
                        activeMembers++;
                    }
                });

                const avgCompletionRate = activeMembers > 0 ? totalCompletionRate / activeMembers : 0;
                const teamUtilization = Math.min(100, (summary.completed_items || 0) / (summary.total_work_items || 1) * 100);

                document.getElementById('totalTeamSize').textContent = teamSize || '--';
                document.getElementById('avgCompletionRate').textContent = avgCompletionRate ? `${avgCompletionRate.toFixed(1)}%` : '--%';
                document.getElementById('avgLeadTime').textContent = leadTime.average_days ? `${leadTime.average_days.toFixed(1)} days` : '-- days';
                document.getElementById('teamUtilization').textContent = `${teamUtilization.toFixed(1)}%`;
            }

            generateExecutiveMockData() {
                // Enhanced mock data for executive dashboard
                return {
                    summary: {
                        total_work_items: 250,
                        completed_items: 187,
                        completion_rate: 74.8
                    },
                    lead_time: {
                        average_days: 12.4,
                        median_days: 10.0,
                        count: 187
                    },
                    cycle_time: {
                        average_days: 8.7,
                        median_days: 7.5,
                        count: 187
                    },
                    throughput: {
                        items_per_period: 23.4,
                        period_days: 30
                    },
                    work_in_progress: {
                        total_wip: 63,
                        wip_by_state: {
                            "Analysis": 8,
                            "Development": 24,
                            "Testing": 18,
                            "Review": 13
                        }
                    },
                    flow_efficiency: {
                        average_efficiency: 0.73
                    },
                    team_metrics: {
                        "Engineering Team Alpha": { completed_items: 45, active_items: 8, completion_rate: 89.2, average_lead_time: 9.8 },
                        "Engineering Team Beta": { completed_items: 38, active_items: 6, completion_rate: 84.7, average_lead_time: 11.2 },
                        "QA Team": { completed_items: 52, active_items: 12, completion_rate: 78.5, average_lead_time: 15.3 },
                        "DevOps Team": { completed_items: 28, active_items: 4, completion_rate: 91.3, average_lead_time: 8.1 },
                        "Product Team": { completed_items: 24, active_items: 7, completion_rate: 77.4, average_lead_time: 13.6 }
                    }
                };
            }

            showNoDataMessage() {
                document.getElementById('deliverySpeed').textContent = '--';
                document.getElementById('flowEfficiency').textContent = '--%';
                document.getElementById('wipItems').textContent = '--';
                document.getElementById('teamVelocity').textContent = '--';
            }

            showErrorMessage(message) {
                this.updateDataSourceInfo('Error: ' + message);
            }

            handleWorkstreamFilter(event) {
                event.preventDefault();
                const target = event.target.closest('[data-workstream]');
                if (!target) return;

                const workstream = target.getAttribute('data-workstream');
                const checkbox = target.querySelector('input[type="checkbox"]');

                if (workstream === 'All Teams') {
                    // Toggle all workstreams
                    if (checkbox.checked) {
                        this.selectedWorkstreams = ['All Teams'];
                        // Uncheck all other checkboxes
                        document.querySelectorAll('#workstreamDropdownMenu input[type="checkbox"]').forEach(cb => {
                            cb.checked = cb.closest('[data-workstream]').getAttribute('data-workstream') === 'All Teams';
                        });
                    } else {
                        checkbox.checked = true; // Keep All Teams checked if trying to uncheck
                        return;
                    }
                } else {
                    // Toggle specific workstream
                    const allTeamsCheckbox = document.querySelector('[data-workstream="All Teams"] input');

                    if (checkbox.checked) {
                        // Add to selection
                        if (this.selectedWorkstreams.includes('All Teams')) {
                            this.selectedWorkstreams = [workstream];
                            allTeamsCheckbox.checked = false;
                        } else if (!this.selectedWorkstreams.includes(workstream)) {
                            this.selectedWorkstreams.push(workstream);
                        }
                    } else {
                        // Remove from selection
                        this.selectedWorkstreams = this.selectedWorkstreams.filter(w => w !== workstream);
                        if (this.selectedWorkstreams.length === 0) {
                            // If no workstreams selected, default to All Teams
                            this.selectedWorkstreams = ['All Teams'];
                            allTeamsCheckbox.checked = true;
                        }
                    }
                }

                this.updateWorkstreamDisplay();
                this.updateExecutiveDashboard(this.data);
                this.updateWorkItemsFilterSummary();
                
                // Update work items table if data has changed
                if (this.currentWorkItems && this.currentWorkItems.length > 0) {
                    this.filterWorkItems();
                    this.updateWorkItemsTable();
                }
            }

            updateWorkstreamDisplay() {
                const button = document.getElementById('workstreamDropdown');
                const info = document.getElementById('workstreamInfo');

                if (this.selectedWorkstreams.includes('All Teams')) {
                    button.innerHTML = '<i class="fas fa-chart-pie me-2"></i>All Workstreams';
                    info.textContent = 'All workstreams included';
                } else if (this.selectedWorkstreams.length === 1) {
                    button.innerHTML = `<i class="fas fa-chart-pie me-2"></i>${this.selectedWorkstreams[0]} Focus`;
                    info.textContent = `Executive view focused on ${this.selectedWorkstreams[0]} workstream`;
                } else {
                    button.innerHTML = `<i class="fas fa-chart-pie me-2"></i>${this.selectedWorkstreams.length} Workstreams`;
                    info.textContent = `Executive view of ${this.selectedWorkstreams.length} workstreams: ${this.selectedWorkstreams.join(', ')}`;
                }
            }

            updateWorkItemsFilterSummary() {
                const summary = document.getElementById('workItemsFilterSummary');
                if (summary) {
                    if (this.selectedWorkstreams.includes('All Teams')) {
                        summary.textContent = 'All Workstreams';
                    } else {
                        summary.textContent = this.selectedWorkstreams.join(', ');
                    }
                }
            }

            // ===== WORK ITEMS TABLE FUNCTIONALITY =====

            extractWorkItems(data) {
                // Extract work items from different data formats
                let workItems = [];
                
                if (data.work_items) {
                    workItems = data.work_items;
                } else if (data.team_metrics) {
                    // Generate work items from team metrics (mock data)
                    workItems = this.generateWorkItemsFromTeamMetrics(data.team_metrics);
                } else if (Array.isArray(data)) {
                    workItems = data;
                }
                
                // Limit work items for better performance - paginate if needed
                const maxWorkItems = 500; // Limit initial load
                const limitedWorkItems = workItems.slice(0, maxWorkItems);
                
                this.currentWorkItems = limitedWorkItems.map(item => ({
                    id: item.id || item.raw_id || Math.random().toString(36),
                    raw_id: item.raw_id || (typeof item.id === 'number' ? item.id : null),
                    title: item.title || 'No Title',
                    type: item.type || 'Task',
                    state: item.current_state || item.state || 'New',
                    assigned_to: item.assigned_to || 'Unassigned',
                    priority: item.priority || 3,
                    created_date: item.created_date || new Date().toISOString(),
                    link: item.link || this.generateWorkItemLink(item),
                    tags: item.tags || [],
                    workstream: this.workstreamManager.getWorkstreamForMember(item.assigned_to || ''),
                    story_points: item.story_points,
                    effort_hours: item.effort_hours
                }));
                
                this.filterWorkItems();
            }

            generateWorkItemsFromTeamMetrics(teamMetrics) {
                // Generate sample work items for demo when real work items aren't available
                const workItems = [];
                let itemId = 1;
                
                Object.entries(teamMetrics).forEach(([memberName, metrics]) => {
                    // Generate completed items
                    for (let i = 0; i < Math.min(metrics.completed_items || 0, 10); i++) {
                        workItems.push({
                            id: 2000000 + itemId, // Use numeric IDs like real ADO
                            raw_id: 2000000 + itemId,
                            title: `${this.getRandomTaskTitle()} - ${memberName}`,
                            type: this.getRandomWorkItemType(),
                            current_state: 'Done',
                            assigned_to: memberName,
                            priority: Math.floor(Math.random() * 4) + 1,
                            created_date: this.getRandomDate(-30, -5),
                            story_points: Math.floor(Math.random() * 8) + 1,
                            link: this.generateWorkItemLink({ id: 2000000 + itemId })
                        });
                        itemId++;
                    }
                    
                    // Generate active items
                    for (let i = 0; i < Math.min(metrics.active_items || 0, 5); i++) {
                        workItems.push({
                            id: 2000000 + itemId, // Use numeric IDs like real ADO
                            raw_id: 2000000 + itemId,
                            title: `${this.getRandomTaskTitle()} - ${memberName}`,
                            type: this.getRandomWorkItemType(),
                            current_state: this.getRandomActiveState(),
                            assigned_to: memberName,
                            priority: Math.floor(Math.random() * 4) + 1,
                            created_date: this.getRandomDate(-20, -1),
                            story_points: Math.floor(Math.random() * 8) + 1,
                            link: this.generateWorkItemLink({ id: 2000000 + itemId })
                        });
                        itemId++;
                    }
                });
                
                return workItems;
            }

            getRandomTaskTitle() {
                const titles = [
                    'Implement user authentication',
                    'Fix database connection issue', 
                    'Update API documentation',
                    'Add data validation',
                    'Optimize query performance',
                    'Create user interface',
                    'Setup automated testing',
                    'Configure deployment pipeline',
                    'Refactor legacy code',
                    'Add monitoring dashboards'
                ];
                return titles[Math.floor(Math.random() * titles.length)];
            }

            getRandomWorkItemType() {
                const types = ['User Story', 'Bug', 'Task', 'Feature'];
                return types[Math.floor(Math.random() * types.length)];
            }

            getRandomActiveState() {
                const states = ['In Progress', 'Active', 'Testing', 'Review'];
                return states[Math.floor(Math.random() * states.length)];
            }

            getRandomDate(minDaysAgo, maxDaysAgo) {
                const now = new Date();
                const randomDays = Math.floor(Math.random() * (maxDaysAgo - minDaysAgo + 1)) + minDaysAgo;
                const date = new Date(now.getTime() + randomDays * 24 * 60 * 60 * 1000);
                return date.toISOString();
            }

            generateWorkItemLink(item) {
                // If item already has a valid link, use it
                if (item.link && item.link !== 'null' && item.link !== null) {
                    return item.link;
                }
                
                // Generate proper web link for Azure DevOps
                // Format: https://org.visualstudio.com/project/_workitems/edit/ID
                const orgUrl = this.config?.azure_devops?.org_url || 'https://dev.azure.com/example-org';
                const projectName = this.config?.azure_devops?.default_project || 'example-project';
                
                // Extract org name from URL
                const orgName = orgUrl.replace('https://dev.azure.com/', '').replace('https://', '').replace('.visualstudio.com', '').trim();
                
                // Get the real Azure DevOps ID for the link
                const realId = this.getRealAzureDevOpsId(item);
                
                if (realId) {
                    return `https://${orgName}.visualstudio.com/${projectName}/_workitems/edit/${realId}`;
                }
                
                return '#';
            }

            filterWorkItems() {
                let filtered = [...this.currentWorkItems];
                
                // Apply workstream filter
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    filtered = this.workstreamManager.filterWorkItemsByWorkstream(filtered, this.selectedWorkstreams);
                }
                
                // Apply drill-down filter if active
                if (this.drilldownFilter) {
                    filtered = filtered.filter(item => this.drilldownFilter(item));
                }
                
                // Apply table view filter
                switch (this.selectedTableView) {
                    case 'completedItemsView':
                        filtered = filtered.filter(item => 
                            ['Done', 'Closed', 'Completed', 'Released', 'Approved'].includes(item.state)
                        );
                        break;
                    case 'activeItemsView':
                        filtered = filtered.filter(item => 
                            ['In Progress', 'Active', 'Development', 'Testing', 'Review'].includes(item.state)
                        );
                        break;
                }
                
                this.filteredWorkItems = filtered;
                this.currentPage = 1;
            }

            updateWorkItemsTable() {
                if (!this.filteredWorkItems.length) {
                    this.showEmptyWorkItemsTable();
                    return;
                }
                
                const startIndex = (this.currentPage - 1) * ExecutiveDashboard.ITEMS_PER_PAGE;
                const endIndex = startIndex + ExecutiveDashboard.ITEMS_PER_PAGE;
                const pageItems = this.filteredWorkItems.slice(startIndex, endIndex);
                
                const tbody = document.getElementById('workItemsTableBody');
                tbody.innerHTML = pageItems.map(item => this.renderWorkItemRow(item)).join('');
                
                this.updateWorkItemsPagination();
                this.updateWorkItemsCount();
            }

            getRealAzureDevOpsId(item) {
                // Simple function - just return the numeric ID
                // All new data should have numeric IDs
                if (item.raw_id) {
                    return item.raw_id;
                }
                
                if (typeof item.id === 'number') {
                    return item.id;
                }
                
                // Handle legacy WI- prefixed IDs
                if (typeof item.id === 'string' && item.id.startsWith('WI-')) {
                    return item.id.substring(3);
                }
                
                return item.id;
            }

            renderWorkItemRow(item) {
                const workstreamClass = `workstream-${item.workstream.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
                const priorityClass = `priority-${item.priority}`;
                const stateClass = `state-${item.state.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
                
                const priorityText = ['', 'Critical', 'High', 'Medium', 'Low'][item.priority] || 'Medium';
                const createdDate = new Date(item.created_date).toLocaleDateString();
                
                // Get the real Azure DevOps ID - use raw_id if available, otherwise extract from id
                const adoId = this.getRealAzureDevOpsId(item);
                
                return `
                    <tr>
                        <td><strong>${adoId}</strong></td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" title="${item.title}">
                                ${item.title}
                            </div>
                        </td>
                        <td><span class="badge bg-secondary">${item.type}</span></td>
                        <td><span class="badge state-badge ${stateClass}">${item.state}</span></td>
                        <td>
                            <div class="text-truncate" style="max-width: 120px;" title="${item.assigned_to}">
                                ${item.assigned_to}
                            </div>
                        </td>
                        <td><span class="badge workstream-badge ${workstreamClass}">${item.workstream}</span></td>
                        <td><span class="badge priority-badge ${priorityClass}">${priorityText}</span></td>
                        <td><small>${createdDate}</small></td>
                        <td>
                            <a href="${item.link}" target="_blank" class="btn btn-sm btn-outline-primary work-item-link" title="Open in Azure DevOps">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </td>
                    </tr>
                `;
            }

            showEmptyWorkItemsTable() {
                const tbody = document.getElementById('workItemsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-search me-2"></i>No work items match the current filters
                        </td>
                    </tr>
                `;
                document.getElementById('workItemsPagination').innerHTML = '';
                this.updateWorkItemsCount();
            }

            updateWorkItemsPagination() {
                const totalPages = Math.ceil(this.filteredWorkItems.length / ExecutiveDashboard.ITEMS_PER_PAGE);
                const pagination = document.getElementById('workItemsPagination');
                
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }
                
                let paginationHTML = '';
                
                paginationHTML += `
                    <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${this.currentPage - 1}">Previous</a>
                    </li>
                `;
                
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(totalPages, this.currentPage + 2);
                
                if (startPage > 1) {
                    paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
                    if (startPage > 2) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                }
                
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                    }
                    paginationHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
                }
                
                paginationHTML += `
                    <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${this.currentPage + 1}">Next</a>
                    </li>
                `;
                
                pagination.innerHTML = paginationHTML;
                
                pagination.querySelectorAll('a[data-page]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = parseInt(e.target.getAttribute('data-page'));
                        if (page >= 1 && page <= totalPages && page !== this.currentPage) {
                            this.currentPage = page;
                            this.updateWorkItemsTable();
                        }
                    });
                });
            }

            updateWorkItemsCount() {
                const countElement = document.getElementById('workItemsCount');
                if (countElement) {
                    countElement.textContent = this.filteredWorkItems.length;
                }
            }

            refreshWorkItems() {
                this.filterWorkItems();
                this.updateWorkItemsTable();
            }

            exportWorkItems() {
                if (!this.filteredWorkItems.length) {
                    alert('No work items to export');
                    return;
                }
                
                const headers = ['ID', 'Title', 'Type', 'State', 'Assigned To', 'Workstream', 'Priority', 'Created Date', 'Link'];
                const csvRows = [headers.join(',')];
                
                this.filteredWorkItems.forEach(item => {
                    const row = [
                        `"${this.getRealAzureDevOpsId(item)}"`,
                        `"${item.title.replace(/"/g, '""')}"`,
                        `"${item.type}"`,
                        `"${item.state}"`,
                        `"${item.assigned_to}"`,
                        `"${item.workstream}"`,
                        `"${['', 'Critical', 'High', 'Medium', 'Low'][item.priority] || 'Medium'}"`,
                        `"${new Date(item.created_date).toLocaleDateString()}"`,
                        `"${item.link}"`
                    ];
                    csvRows.push(row.join(','));
                });
                
                const csvContent = csvRows.join('\\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `work-items-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            // ===== CHART DRILL-DOWN FUNCTIONALITY =====

            enableChartDrilldown() {
                setTimeout(() => {
                    const deliveryChart = document.getElementById('deliveryTrendsChart');
                    if (deliveryChart) {
                        deliveryChart.classList.add('chart-clickable');
                        deliveryChart.onclick = () => this.drilldownToWorkItems('delivery');
                    }
                    
                    const workDistChart = document.getElementById('workDistributionChart');
                    if (workDistChart) {
                        workDistChart.classList.add('chart-clickable');
                        workDistChart.onclick = () => this.drilldownToWorkItems('distribution');
                    }
                    
                    const throughputChart = document.getElementById('throughputChart');
                    if (throughputChart) {
                        throughputChart.classList.add('chart-clickable');
                        throughputChart.onclick = () => this.drilldownToWorkItems('throughput');
                    }
                }, 1000);
            }

            drilldownToWorkItems(chartType) {
                const workItemsTab = document.getElementById('nav-workitems-tab');
                const bsTab = new bootstrap.Tab(workItemsTab);
                bsTab.show();
                
                switch (chartType) {
                    case 'delivery':
                        this.drilldownFilter = (item) => ['Done', 'Closed', 'Completed'].includes(item.state);
                        document.getElementById('completedItemsView').checked = true;
                        this.selectedTableView = 'completedItemsView';
                        break;
                    case 'distribution':
                        this.drilldownFilter = null;
                        document.getElementById('allItemsView').checked = true;
                        this.selectedTableView = 'allItemsView';
                        break;
                    case 'throughput':
                        this.drilldownFilter = (item) => ['In Progress', 'Active', 'Development', 'Testing', 'Review'].includes(item.state);
                        document.getElementById('activeItemsView').checked = true;
                        this.selectedTableView = 'activeItemsView';
                        break;
                }
                
                this.filterWorkItems();
                this.updateWorkItemsTable();
            }
        }

        // Initialize executive dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new ExecutiveDashboard();
        });
    </script>
</body>
</html>
