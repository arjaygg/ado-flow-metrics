<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Fixes Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="js/predictive-analytics.js"></script>
    <script src="js/time-series-analysis.js"></script>
    <script src="js/enhanced-ux.js"></script>
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .chart-test { height: 300px; margin: 20px 0; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container my-4">
        <h1>Chart Functionality Test</h1>
        <div id="testResults"></div>
        
        <h2>Chart Rendering Tests</h2>
        <div class="row">
            <div class="col-md-6">
                <h5>Delivery Forecast Chart</h5>
                <div id="forecastChart" class="chart-test"></div>
            </div>
            <div class="col-md-6">
                <h5>Velocity Trend Chart</h5>
                <div id="velocityTrendChart" class="chart-test"></div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h5>Moving Averages Chart</h5>
                <div id="movingAveragesChart" class="chart-test"></div>
            </div>
            <div class="col-md-6">
                <h5>Period Comparison Chart</h5>
                <div id="periodComparisonChart" class="chart-test"></div>
            </div>
        </div>
    </div>

    <script>
        class ChartTester {
            constructor() {
                this.results = [];
                this.predictiveAnalytics = null;
                this.timeSeriesAnalyzer = null;
                this.enhancedUX = null;
            }

            addResult(testName, passed, message) {
                this.results.push({ testName, passed, message });
                this.displayResults();
            }

            displayResults() {
                const container = document.getElementById('testResults');
                container.innerHTML = this.results.map(result => `
                    <div class="test-result ${result.passed ? 'test-pass' : 'test-fail'}">
                        <strong>${result.testName}:</strong> ${result.message}
                    </div>
                `).join('');
            }

            async runTests() {
                console.log('Starting chart functionality tests...');

                // Test 1: Module Initialization
                try {
                    this.predictiveAnalytics = new PredictiveAnalytics();
                    this.timeSeriesAnalyzer = new TimeSeriesAnalyzer();
                    this.enhancedUX = new EnhancedUX();
                    this.addResult('Module Initialization', true, 'All modules initialized successfully');
                } catch (error) {
                    this.addResult('Module Initialization', false, `Failed: ${error.message}`);
                    return;
                }

                // Test 2: Sample Data Generation
                try {
                    const sampleData = this.generateSampleHistoricalData();
                    const hasData = sampleData && sampleData.length > 0;
                    this.addResult('Sample Data Generation', hasData, 
                        hasData ? `Generated ${sampleData.length} sample items` : 'Failed to generate sample data');
                } catch (error) {
                    this.addResult('Sample Data Generation', false, `Failed: ${error.message}`);
                }

                // Test 3: Predictive Analytics with Sample Data
                try {
                    const sampleData = this.generateSampleHistoricalData();
                    this.predictiveAnalytics.initialize(sampleData);
                    const prediction = this.predictiveAnalytics.predictDeliveryDate(20, { confidenceLevel: 0.85 });
                    const hasValidPrediction = prediction && prediction.weeksToComplete && prediction.range;
                    this.addResult('Predictive Analytics', hasValidPrediction, 
                        hasValidPrediction ? 'Successfully generated delivery forecast' : 'Failed to generate prediction');
                } catch (error) {
                    this.addResult('Predictive Analytics', false, `Failed: ${error.message}`);
                }

                // Test 4: Time Series Analysis
                try {
                    const timeSeriesData = this.prepareTimeSeriesData();
                    this.timeSeriesAnalyzer.initialize(timeSeriesData);
                    const analysis = this.timeSeriesAnalyzer.getAnalysis('leadTime');
                    const hasValidAnalysis = analysis && analysis.movingAverages && analysis.rawData;
                    this.addResult('Time Series Analysis', hasValidAnalysis, 
                        hasValidAnalysis ? 'Successfully analyzed time series data' : 'Failed to analyze time series');
                } catch (error) {
                    this.addResult('Time Series Analysis', false, `Failed: ${error.message}`);
                }

                // Test 5: Chart Rendering
                await this.testChartRendering();

                console.log('All tests completed!');
            }

            async testChartRendering() {
                try {
                    // Test Delivery Forecast Chart
                    await this.renderForecastChart();
                    this.addResult('Delivery Forecast Chart', true, 'Chart rendered successfully');

                    // Test Velocity Trend Chart
                    await this.renderVelocityChart();
                    this.addResult('Velocity Trend Chart', true, 'Chart rendered successfully');

                    // Test Moving Averages Chart
                    await this.renderMovingAveragesChart();
                    this.addResult('Moving Averages Chart', true, 'Chart rendered successfully');

                    // Test Period Comparison Chart
                    await this.renderPeriodComparisonChart();
                    this.addResult('Period Comparison Chart', true, 'Chart rendered successfully');

                } catch (error) {
                    this.addResult('Chart Rendering', false, `Failed: ${error.message}`);
                }
            }

            async renderForecastChart() {
                const trace = {
                    x: ['Optimistic', 'Realistic', 'Pessimistic'],
                    y: [6, 8, 12],
                    type: 'bar',
                    marker: { color: ['#1cc88a', '#4e73df', '#f6c23e'] },
                    text: ['6.0 weeks', '8.0 weeks', '12.0 weeks'],
                    textposition: 'auto'
                };

                const layout = {
                    title: 'Delivery Timeline Forecast (Test)',
                    xaxis: { title: 'Confidence Level' },
                    yaxis: { title: 'Weeks to Complete' },
                    margin: { t: 40, b: 40, l: 60, r: 20 }
                };

                await Plotly.newPlot('forecastChart', [trace], layout, { responsive: true });
            }

            async renderVelocityChart() {
                const trace = {
                    x: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                    y: [8, 9, 7, 10, 8, 9],
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#4e73df', width: 2 },
                    marker: { size: 6 }
                };

                const layout = {
                    title: 'Velocity Trend (Test)',
                    xaxis: { title: 'Time Period' },
                    yaxis: { title: 'Items/Week' },
                    margin: { t: 40, b: 40, l: 60, r: 20 }
                };

                await Plotly.newPlot('velocityTrendChart', [trace], layout, { responsive: true });
            }

            async renderMovingAveragesChart() {
                const dates = ['2024-01-01', '2024-01-02', '2024-01-03', '2024-01-04', '2024-01-05', '2024-01-06', '2024-01-07'];
                const rawData = [5, 7, 6, 8, 5, 9, 7];
                const ma7 = [5, 6, 6.3, 6.5, 6.2, 6.8, 6.7];

                const traces = [
                    {
                        x: dates,
                        y: rawData,
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Raw Data',
                        marker: { color: '#e3e6f0', size: 4 }
                    },
                    {
                        x: dates,
                        y: ma7,
                        type: 'scatter',
                        mode: 'lines',
                        name: '7-day MA',
                        line: { color: '#4e73df', width: 2 }
                    }
                ];

                const layout = {
                    title: 'Moving Averages (Test)',
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Value' },
                    margin: { t: 40, b: 40, l: 60, r: 20 },
                    legend: { x: 0, y: 1 }
                };

                await Plotly.newPlot('movingAveragesChart', traces, layout, { responsive: true });
            }

            async renderPeriodComparisonChart() {
                const trace = {
                    x: ['Previous Period', 'Current Period'],
                    y: [6.5, 5.8],
                    type: 'bar',
                    marker: { color: ['#f6c23e', '#4e73df'] }
                };

                const layout = {
                    title: 'Period Comparison (Test)',
                    yaxis: { title: 'Average Lead Time (days)' },
                    margin: { t: 40, b: 40, l: 60, r: 20 }
                };

                await Plotly.newPlot('periodComparisonChart', [trace], layout, { responsive: true });
            }

            generateSampleHistoricalData() {
                const sampleData = [];
                const today = new Date();
                
                for (let i = 30; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    
                    const leadTime = 3 + Math.random() * 7;
                    const cycleTime = 2 + Math.random() * 4;
                    
                    for (let j = 0; j < Math.floor(Math.random() * 3) + 1; j++) {
                        sampleData.push({
                            id: `sample-${i}-${j}`,
                            resolvedDate: date.toISOString().split('T')[0],
                            leadTime: leadTime + (Math.random() - 0.5) * 2,
                            cycleTime: cycleTime + (Math.random() - 0.5) * 1,
                            state: 'Done',
                            workItemType: 'User Story'
                        });
                    }
                }
                
                return sampleData;
            }

            prepareTimeSeriesData() {
                const timeSeriesData = [];
                const sampleData = this.generateSampleHistoricalData();
                
                sampleData.forEach(item => {
                    if (item.resolvedDate) {
                        timeSeriesData.push({
                            date: item.resolvedDate,
                            value: item.leadTime || 0,
                            metric: 'leadTime'
                        });
                        timeSeriesData.push({
                            date: item.resolvedDate,
                            value: item.cycleTime || 0,
                            metric: 'cycleTime'
                        });
                    }
                });

                return timeSeriesData;
            }
        }

        // Initialize and run tests when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            const tester = new ChartTester();
            await tester.runTests();
        });
    </script>
</body>
</html>