<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Metrics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="js/workstream_config.js"></script>
    <script src="js/workstream-manager.js"></script>
    <script src="js/predictive-analytics.js"></script>
    <script src="js/time-series-analysis.js"></script>
    <script src="js/enhanced-ux.js"></script>
    <script src="js/advanced-filtering.js"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fc;
        }

        .metric-card {
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }

        .metric-card.success { border-left-color: var(--success-color); }
        .metric-card.info { border-left-color: var(--info-color); }
        .metric-card.warning { border-left-color: var(--warning-color); }

        .chart-container {
            background: white;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .data-source-selector {
            background: white;
            border-radius: 0.35rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        
        .advanced-filtering-panel {
            background: white;
            border-radius: 0.35rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
        }
        
        .filter-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .preset-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .preset-btn:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }
        
        .preset-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .filter-summary {
            background: #f8f9fa;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--info-color);
        }
        
        .filter-summary.active {
            border-left-color: var(--success-color);
        }
        
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.5rem;
        }
        
        .filter-chip {
            background: var(--info-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .filter-chip .remove-chip {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .filter-chip .remove-chip:hover {
            opacity: 1;
        }
        
        .drill-down-breadcrumb {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .breadcrumb-item {
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .breadcrumb-item:not(:last-child)::after {
            content: '>';
            margin-left: 0.5rem;
            color: #6c757d;
        }
        
        .breadcrumb-link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }
        
        .breadcrumb-link:hover {
            text-decoration: underline;
        }
        
        .filter-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .filter-history-nav {
            display: flex;
            gap: 0.25rem;
        }
        
        .filter-history-nav button {
            padding: 0.25rem 0.5rem;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-history-nav button:hover:not(:disabled) {
            background: #f8f9fa;
        }
        
        .filter-history-nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .filter-panel-collapsed .filter-content {
            display: none;
        }
        
        .multi-select {
            position: relative;
        }
        
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .multi-select-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .multi-select-option:hover {
            background: #f8f9fa;
        }
        
        .multi-select-option.selected {
            background: var(--primary-color);
            color: white;
        }
        
        .date-range-picker {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .filter-presets {
                flex-direction: column;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-range-picker {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line"></i> Flow Metrics Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light btn-sm" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-light btn-sm ms-2" id="loadFileBtn">
                    <i class="fas fa-upload"></i> Load JSON
                </button>
                <div class="form-check form-switch ms-3">
                    <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
                    <label class="form-check-label text-light" for="autoRefreshToggle">
                        Auto-refresh (30s)
                    </label>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Data Source Selection -->
        <div class="data-source-selector">
            <div class="row align-items-center mb-3">
                <div class="col-md-6">
                    <h6 class="mb-0">Data Source</h6>
                    <small class="text-muted" id="dataSourceInfo">No data loaded</small>
                </div>
                <div class="col-md-6">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="dataSource" id="mockData" checked>
                        <label class="btn btn-outline-primary" for="mockData">Mock Data</label>

                        <input type="radio" class="btn-check" name="dataSource" id="jsonFile">
                        <label class="btn btn-outline-primary" for="jsonFile">JSON File</label>

                        <input type="radio" class="btn-check" name="dataSource" id="indexedDB">
                        <label class="btn btn-outline-primary" for="indexedDB">IndexedDB</label>

                        <input type="radio" class="btn-check" name="dataSource" id="cliData">
                        <label class="btn btn-outline-primary" for="cliData">CLI Data</label>
                    </div>
                </div>
            </div>
            <!-- Workstream Filter -->
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-0">Workstream Filter</h6>
                    <small class="text-muted" id="workstreamInfo">All teams included</small>
                </div>
                <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="workstreamDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-users me-2"></i>All Teams
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="workstreamDropdown" id="workstreamDropdownMenu">
                            <li><a class="dropdown-item" href="#" data-workstream="All Teams">
                                <input type="checkbox" class="form-check-input me-2" checked> All Teams
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <!-- Workstream options will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Filtering Panel -->
        <div class="advanced-filtering-panel" id="advancedFilteringPanel">
            <div class="filter-toggle" onclick="toggleFilterPanel()">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Advanced Filtering & Drill-Down
                </h5>
                <i class="fas fa-chevron-down ms-auto" id="filterToggleIcon"></i>
            </div>
            
            <div class="filter-content" id="filterContent">
                <!-- Filter Summary -->
                <div class="filter-summary" id="filterSummary">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Active Filters:</strong>
                            <span id="filterCount">None</span>
                        </div>
                        <div class="filter-controls">
                            <div class="filter-history-nav">
                                <button type="button" id="filterBackBtn" onclick="goBackFilter()" disabled>
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button type="button" id="filterForwardBtn" onclick="goForwardFilter()" disabled>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
                                <i class="fas fa-times me-1"></i>Clear All
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="shareFilters()">
                                <i class="fas fa-share me-1"></i>Share
                            </button>
                        </div>
                    </div>
                    <div class="filter-chips" id="filterChips"></div>
                </div>

                <!-- Drill-down Breadcrumb -->
                <div class="drill-down-breadcrumb" id="drillDownBreadcrumb" style="display: none;">
                    <i class="fas fa-sitemap me-2"></i>
                    <span class="text-muted">Drill-down Path:</span>
                    <div class="breadcrumb-items" id="breadcrumbItems"></div>
                </div>

                <!-- Filter Presets -->
                <div class="filter-section">
                    <h6 class="mb-2">Quick Presets</h6>
                    <div class="filter-presets" id="filterPresets">
                        <button class="preset-btn" data-preset="last7days">Last 7 Days</button>
                        <button class="preset-btn" data-preset="last30days">Last 30 Days</button>
                        <button class="preset-btn" data-preset="current-sprint">Current Sprint</button>
                        <button class="preset-btn" data-preset="high-priority">High Priority</button>
                        <button class="preset-btn" data-preset="bugs-only">Bugs Only</button>
                        <button class="preset-btn" data-preset="completed-items">Completed Items</button>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div class="row">
                    <!-- Date Range Filter -->
                    <div class="col-md-6 filter-section">
                        <h6 class="mb-2">Date Range</h6>
                        <div class="date-range-picker">
                            <input type="date" class="form-control" id="startDateFilter" placeholder="Start Date">
                            <span class="align-self-center">to</span>
                            <input type="date" class="form-control" id="endDateFilter" placeholder="End Date">
                        </div>
                    </div>

                    <!-- Work Item Types Filter -->
                    <div class="col-md-6 filter-section">
                        <h6 class="mb-2">Work Item Types</h6>
                        <div class="multi-select" id="workItemTypesFilter">
                            <input type="text" class="form-control" placeholder="Select work item types..." readonly onclick="toggleMultiSelect('workItemTypes')">
                            <div class="multi-select-dropdown" id="workItemTypesDropdown" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Priorities Filter -->
                    <div class="col-md-6 filter-section">
                        <h6 class="mb-2">Priorities</h6>
                        <div class="multi-select" id="prioritiesFilter">
                            <input type="text" class="form-control" placeholder="Select priorities..." readonly onclick="toggleMultiSelect('priorities')">
                            <div class="multi-select-dropdown" id="prioritiesDropdown" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Assignees Filter -->
                    <div class="col-md-6 filter-section">
                        <h6 class="mb-2">Assignees</h6>
                        <div class="multi-select" id="assigneesFilter">
                            <input type="text" class="form-control" placeholder="Select assignees..." readonly onclick="toggleMultiSelect('assignees')">
                            <div class="multi-select-dropdown" id="assigneesDropdown" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- States Filter -->
                    <div class="col-md-6 filter-section">
                        <h6 class="mb-2">States</h6>
                        <div class="multi-select" id="statesFilter">
                            <input type="text" class="form-control" placeholder="Select states..." readonly onclick="toggleMultiSelect('states')">
                            <div class="multi-select-dropdown" id="statesDropdown" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Tags Filter -->
                    <div class="col-md-6 filter-section">
                        <h6 class="mb-2">Tags</h6>
                        <div class="multi-select" id="tagsFilter">
                            <input type="text" class="form-control" placeholder="Select tags..." readonly onclick="toggleMultiSelect('tags')">
                            <div class="multi-select-dropdown" id="tagsDropdown" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Save Custom Preset -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="customPresetName" placeholder="Save current filters as preset...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-success w-100" onclick="saveCustomPreset()">
                                <i class="fas fa-save me-1"></i>Save Preset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Cards -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card metric-card h-100">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-primary text-uppercase mb-1">Lead Time</div>
                                <div class="h5 mb-0 fw-bold text-gray-800" id="leadTimeAvg">Loading...</div>
                                <div class="small text-muted" id="leadTimeMedian">Median: --</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card metric-card success h-100">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-success text-uppercase mb-1">Cycle Time</div>
                                <div class="h5 mb-0 fw-bold text-gray-800" id="cycleTimeAvg">Loading...</div>
                                <div class="small text-muted" id="cycleTimeMedian">Median: --</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-cog fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card metric-card info h-100">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-info text-uppercase mb-1">Throughput</div>
                                <div class="h5 mb-0 fw-bold text-gray-800" id="throughputValue">Loading...</div>
                                <div class="small text-muted">items/30 days</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-rocket fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card metric-card warning h-100">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-warning text-uppercase mb-1">Work in Progress</div>
                                <div class="h5 mb-0 fw-bold text-gray-800" id="wipValue">Loading...</div>
                                <div class="small text-muted">active items</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-tasks fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h6 class="text-primary mb-3">Lead Time vs Cycle Time</h6>
                    <div id="leadCycleChart" style="height: 300px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h6 class="text-primary mb-3">Work in Progress by State</h6>
                    <div id="wipChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Team Performance -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h6 class="text-primary mb-3">Team Performance</h6>
                    <div id="teamChart" style="height: 400px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h6 class="text-primary mb-3">Flow Efficiency</h6>
                    <div id="efficiencyChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Predictive Analytics Section -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-primary mb-0">Delivery Forecast</h6>
                        <div class="d-flex gap-2">
                            <select id="forecastItems" class="form-select form-select-sm" style="width: auto;">
                                <option value="10">10 items</option>
                                <option value="20" selected>20 items</option>
                                <option value="50">50 items</option>
                                <option value="100">100 items</option>
                            </select>
                            <button id="updateForecast" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-sync"></i> Update
                            </button>
                        </div>
                    </div>
                    <div id="forecastChart" style="height: 300px;"></div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="text-success fw-bold" id="optimisticDate">--</div>
                                <small class="text-muted">Optimistic (10%)</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="text-primary fw-bold" id="realisticDate">--</div>
                                <small class="text-muted">Realistic (50%)</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="text-warning fw-bold" id="pessimisticDate">--</div>
                                <small class="text-muted">Pessimistic (90%)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h6 class="text-primary mb-3">Velocity Trend</h6>
                    <div id="velocityTrendChart" style="height: 200px;"></div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Trend Direction</span>
                            <span id="trendDirection" class="badge bg-secondary">--</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Risk Level</span>
                            <span id="riskLevel" class="badge bg-secondary">--</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Confidence</span>
                            <span id="forecastConfidence" class="fw-bold">--%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights and Recommendations -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="chart-container">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-lightbulb me-2"></i>Insights & Recommendations
                    </h6>
                    <div id="insightsContainer">
                        <div class="row" id="insightCards">
                            <!-- Insight cards will be populated dynamically -->
                        </div>
                        <div class="mt-3">
                            <h6 class="text-secondary mb-2">Recommendations</h6>
                            <ul id="recommendationsList" class="list-unstyled">
                                <!-- Recommendations will be populated dynamically -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Series Analysis -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-primary mb-0">Moving Averages</h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="maMetric" id="ma-leadtime" value="leadTime" checked>
                            <label class="btn btn-outline-primary" for="ma-leadtime">Lead Time</label>
                            <input type="radio" class="btn-check" name="maMetric" id="ma-cycletime" value="cycleTime">
                            <label class="btn btn-outline-primary" for="ma-cycletime">Cycle Time</label>
                            <input type="radio" class="btn-check" name="maMetric" id="ma-throughput" value="throughput">
                            <label class="btn btn-outline-primary" for="ma-throughput">Throughput</label>
                        </div>
                    </div>
                    <div id="movingAveragesChart" style="height: 300px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h6 class="text-primary mb-3">Period Comparison</h6>
                    <div id="periodComparisonChart" style="height: 300px;"></div>
                    <div class="mt-3">
                        <div class="row text-center">
                            <div class="col">
                                <div class="text-primary fw-bold" id="currentPeriodValue">--</div>
                                <small class="text-muted">Current Period</small>
                            </div>
                            <div class="col">
                                <div class="text-secondary fw-bold" id="previousPeriodValue">--</div>
                                <small class="text-muted">Previous Period</small>
                            </div>
                            <div class="col">
                                <div id="periodChange" class="fw-bold">--%</div>
                                <small class="text-muted">Change</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Table -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h6 class="text-primary mb-3">Team Details</h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Team Member</th>
                                    <th>Completed</th>
                                    <th>Active</th>
                                    <th>Completion Rate</th>
                                    <th>Avg Lead Time</th>
                                </tr>
                            </thead>
                            <tbody id="teamTableBody">
                                <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Enhanced Flow Metrics Dashboard with Predictive Analytics
        class FlowDashboard {
            constructor() {
                this.data = null;
                this.dbName = 'FlowMetricsDB';
                this.dbVersion = 1;
                this.db = null;
                this.autoRefreshTimer = null;
                this.autoRefreshInterval = 30000; // 30 seconds
                this.lastDataSource = null;
                this.workstreamManager = new WorkstreamManager();
                this.selectedWorkstreams = ['All Teams'];
                
                // Initialize new feature modules
                this.predictiveAnalytics = new PredictiveAnalytics();
                this.timeSeriesAnalyzer = new TimeSeriesAnalyzer();
                this.enhancedUX = new EnhancedUX();
                this.advancedFiltering = new AdvancedFiltering();
                
                this.init();
            }

            async init() {
                await this.initIndexedDB();
                await this.initWorkstreams();
                this.setupEventListeners();
                this.setupEnhancedFeatures();
                this.loadData();
            }

            async initWorkstreams() {
                try {
                    await this.workstreamManager.init();
                    this.populateWorkstreamFilter();
                    console.log('Workstream filtering initialized');
                } catch (error) {
                    console.error('Failed to initialize workstream filtering:', error);
                }
            }

            populateWorkstreamFilter() {
                const menu = document.getElementById('workstreamDropdownMenu');
                const workstreams = this.workstreamManager.getAvailableWorkstreams();

                // Clear existing workstream items (keep All Teams)
                const existingItems = menu.querySelectorAll('[data-workstream]:not([data-workstream="All Teams"])');
                existingItems.forEach(item => item.parentElement.remove());

                // Add workstream options
                workstreams.forEach(workstream => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a class="dropdown-item" href="#" data-workstream="${workstream}">
                            <input type="checkbox" class="form-check-input me-2"> ${workstream}
                        </a>
                    `;
                    menu.appendChild(li);
                });
            }

            // IndexedDB initialization
            async initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('metrics')) {
                            const store = db.createObjectStore('metrics', { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };
                });
            }

            // Save data to IndexedDB
            async saveToIndexedDB(data) {
                const transaction = this.db.transaction(['metrics'], 'readwrite');
                const store = transaction.objectStore('metrics');
                const record = {
                    id: 'latest',
                    timestamp: new Date().toISOString(),
                    data: data
                };
                await store.put(record);
            }

            // Load data from IndexedDB
            async loadFromIndexedDB() {
                const transaction = this.db.transaction(['metrics'], 'readonly');
                const store = transaction.objectStore('metrics');
                return new Promise((resolve) => {
                    const request = store.get('latest');
                    request.onsuccess = () => {
                        resolve(request.result ? request.result.data : null);
                    };
                    request.onerror = () => resolve(null);
                });
            }

            setupEventListeners() {
                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadData();
                });

                // Load file button
                document.getElementById('loadFileBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                // File input
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileLoad(e);
                });

                // Data source radio buttons
                document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                    radio.addEventListener('change', () => this.loadData());
                });

                // Workstream filter
                document.getElementById('workstreamDropdownMenu').addEventListener('click', (e) => {
                    this.handleWorkstreamFilter(e);
                });

                // Auto-refresh toggle
                document.getElementById('autoRefreshToggle').addEventListener('change', (e) => {
                    this.toggleAutoRefresh(e.target.checked);
                });
            }

            setupEnhancedFeatures() {
                // Predictive analytics controls
                document.getElementById('updateForecast').addEventListener('click', () => {
                    this.updatePredictiveAnalytics();
                });

                document.getElementById('forecastItems').addEventListener('change', () => {
                    this.updatePredictiveAnalytics();
                });

                // Time series analysis controls
                document.querySelectorAll('input[name="maMetric"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.updateMovingAverages(radio.value);
                    });
                });

                // Initialize skeleton loading for new components
                this.enhancedUX.showSkeleton('forecastChart', 'chart');
                this.enhancedUX.showSkeleton('velocityTrendChart', 'chart');
                this.enhancedUX.showSkeleton('movingAveragesChart', 'chart');
                this.enhancedUX.showSkeleton('periodComparisonChart', 'chart');
                this.enhancedUX.showSkeleton('insightCards', 'predictiveCard');
                
                // Initialize advanced filtering
                this.setupAdvancedFiltering();
            }

            async loadData() {
                const selectedSource = document.querySelector('input[name="dataSource"]:checked').id;

                try {
                    let data = null;

                    switch (selectedSource) {
                        case 'mockData':
                            data = this.generateMockData();
                            this.updateDataSourceInfo('Mock data generated');
                            break;
                        case 'jsonFile':
                            data = this.data; // Use last loaded file
                            this.updateDataSourceInfo(data ? 'JSON file loaded' : 'No JSON file loaded');
                            break;
                        case 'indexedDB':
                            data = await this.loadFromIndexedDB();
                            this.updateDataSourceInfo(data ? 'Data loaded from IndexedDB' : 'No data in IndexedDB');
                            break;
                        case 'cliData':
                            data = await this.loadFromCLI();
                            this.updateDataSourceInfo(data ? 'CLI data loaded' : 'No CLI data available');
                            break;
                    }

                    if (data) {
                        this.data = data;
                        this.lastDataSource = selectedSource;
                        this.updateDashboard(data);

                        // Auto-save to IndexedDB for future use
                        if (selectedSource !== 'indexedDB') {
                            await this.saveToIndexedDB(data);
                        }
                    } else {
                        this.showNoDataMessage();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showErrorMessage(error.message);
                }
            }

            // Load data from CLI-generated files
            async loadFromCLI() {
                try {
                    // Try multiple CLI data locations
                    const dataSources = [
                        './data/dashboard_data.json',
                        './data/flow_metrics_report.json',
                        './data/test_report.json',
                        './data/test_metrics_report.json'
                    ];

                    for (const source of dataSources) {
                        try {
                            const response = await fetch(source);
                            if (response.ok) {
                                const data = await response.json();
                                console.log(`Successfully loaded data from ${source}`);

                                // Handle different data formats
                                if (data.data) {
                                    return data.data; // Dashboard format
                                } else if (data.summary || data.lead_time || data.cycle_time) {
                                    return data; // Direct metrics format
                                }
                            }
                        } catch (err) {
                            console.log(`Failed to load from ${source}: ${err.message}`);
                        }
                    }

                    console.log('No CLI data found in any location');
                    return null;
                } catch (error) {
                    console.log('CLI data loading error:', error.message);
                    return null;
                }
            }

            handleFileLoad(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.data = data;
                        document.getElementById('jsonFile').checked = true;
                        this.updateDataSourceInfo(`File: ${file.name} (${file.size} bytes)`);
                        this.updateDashboard(data);

                        // Save to IndexedDB
                        this.saveToIndexedDB(data);
                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            updateDataSourceInfo(message) {
                document.getElementById('dataSourceInfo').textContent = message + ' - ' + new Date().toLocaleTimeString();
            }

            updateDashboard(data) {
                this.updateMetricsCards(data);
                this.updateCharts(data);
                this.updateTeamTable(data);
                
                // Update enhanced features
                this.updatePredictiveAnalytics(data);
                this.updateTimeSeriesAnalysis(data);
                this.updateInsightsAndRecommendations(data);
                
                // Update advanced filtering dropdowns with new data
                this.updateFilteringDropdowns(data);
            }

            updateMetricsCards(data) {
                const summary = data.summary || {};
                let leadTime = data.lead_time || {};
                let cycleTime = data.cycle_time || {};
                let throughput = data.throughput || {};
                let wip = data.work_in_progress || {};

                // Apply workstream filtering to metrics if workstream filter is active
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    const filteredTeamMetrics = this.workstreamManager.filterTeamMetrics(data.team_metrics || {}, this.selectedWorkstreams);

                    // Recalculate metrics for filtered teams
                    if (Object.keys(filteredTeamMetrics).length > 0) {
                        const metrics = Object.values(filteredTeamMetrics);

                        // Recalculate lead time
                        const leadTimes = metrics.map(m => m.average_lead_time || 0).filter(t => t > 0);
                        if (leadTimes.length > 0) {
                            leadTime = {
                                average_days: leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length,
                                median_days: leadTimes.sort((a, b) => a - b)[Math.floor(leadTimes.length / 2)]
                            };
                        }

                        // Recalculate cycle time
                        const cycleTimes = metrics.map(m => m.average_cycle_time || 0).filter(t => t > 0);
                        if (cycleTimes.length > 0) {
                            cycleTime = {
                                average_days: cycleTimes.reduce((a, b) => a + b, 0) / cycleTimes.length,
                                median_days: cycleTimes.sort((a, b) => a - b)[Math.floor(cycleTimes.length / 2)]
                            };
                        }

                        // Recalculate throughput
                        const completedItems = metrics.reduce((sum, m) => sum + (m.completed_items || 0), 0);
                        throughput = { items_per_period: completedItems };

                        // Recalculate WIP
                        const activeItems = metrics.reduce((sum, m) => sum + (m.active_items || 0), 0);
                        wip = { total_wip: activeItems };
                    }
                }

                // Lead time
                document.getElementById('leadTimeAvg').textContent = `${(leadTime.average_days || 0).toFixed(1)} days`;
                document.getElementById('leadTimeMedian').textContent = `Median: ${(leadTime.median_days || 0).toFixed(1)} days`;

                // Cycle time
                document.getElementById('cycleTimeAvg').textContent = `${(cycleTime.average_days || 0).toFixed(1)} days`;
                document.getElementById('cycleTimeMedian').textContent = `Median: ${(cycleTime.median_days || 0).toFixed(1)} days`;

                // Throughput
                document.getElementById('throughputValue').textContent = `${(throughput.items_per_period || 0).toFixed(1)}`;

                // WIP
                document.getElementById('wipValue').textContent = wip.total_wip || 0;
            }

            updateCharts(data) {
                this.updateLeadCycleChart(data);
                this.updateWipChart(data);
                this.updateTeamChart(data);
                this.updateEfficiencyChart(data);
            }

            updateLeadCycleChart(data) {
                let leadTime = data.lead_time || {};
                let cycleTime = data.cycle_time || {};

                // Apply workstream filtering to lead/cycle times
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    const filteredTeamMetrics = this.workstreamManager.filterTeamMetrics(data.team_metrics || {}, this.selectedWorkstreams);

                    if (Object.keys(filteredTeamMetrics).length > 0) {
                        const metrics = Object.values(filteredTeamMetrics);

                        // Recalculate lead time for filtered teams
                        const leadTimes = metrics.map(m => m.average_lead_time || 0).filter(t => t > 0);
                        if (leadTimes.length > 0) {
                            leadTime = {
                                average_days: leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length,
                                median_days: leadTimes.sort((a, b) => a - b)[Math.floor(leadTimes.length / 2)]
                            };
                        }

                        // Recalculate cycle time for filtered teams
                        const cycleTimes = metrics.map(m => m.average_cycle_time || 0).filter(t => t > 0);
                        if (cycleTimes.length > 0) {
                            cycleTime = {
                                average_days: cycleTimes.reduce((a, b) => a + b, 0) / cycleTimes.length,
                                median_days: cycleTimes.sort((a, b) => a - b)[Math.floor(cycleTimes.length / 2)]
                            };
                        }
                    }
                }

                const chartData = [
                    {
                        x: ['Average', 'Median'],
                        y: [leadTime.average_days || 0, leadTime.median_days || 0],
                        name: 'Lead Time',
                        type: 'bar',
                        marker: { color: '#4e73df' }
                    },
                    {
                        x: ['Average', 'Median'],
                        y: [cycleTime.average_days || 0, cycleTime.median_days || 0],
                        name: 'Cycle Time',
                        type: 'bar',
                        marker: { color: '#1cc88a' }
                    }
                ];

                const layout = {
                    margin: { l: 50, r: 50, t: 20, b: 50 },
                    yaxis: { title: 'Days' },
                    showlegend: true
                };

                Plotly.newPlot('leadCycleChart', chartData, layout, { responsive: true });
            }

            updateWipChart(data) {
                let wip = data.work_in_progress || {};
                let wipByState = wip.wip_by_state || {};

                // Apply workstream filtering to WIP data
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    const filteredTeamMetrics = this.workstreamManager.filterTeamMetrics(data.team_metrics || {}, this.selectedWorkstreams);

                    if (Object.keys(filteredTeamMetrics).length > 0) {
                        // Recalculate WIP by state for filtered teams
                        const activeItems = Object.values(filteredTeamMetrics).reduce((sum, m) => sum + (m.active_items || 0), 0);
                        const blockedItems = Object.values(filteredTeamMetrics).reduce((sum, m) => sum + (m.blocked_items || 0), 0);

                        wipByState = {
                            'Active': activeItems,
                            'Blocked': blockedItems
                        };
                    }
                }

                if (Object.keys(wipByState).length === 0) {
                    document.getElementById('wipChart').innerHTML = '<p class="text-center text-muted">No WIP data</p>';
                    return;
                }

                const chartData = [{
                    labels: Object.keys(wipByState),
                    values: Object.values(wipByState),
                    type: 'pie',
                    hole: 0.4,
                    marker: { colors: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'] }
                }];

                const layout = {
                    margin: { l: 20, r: 20, t: 20, b: 20 },
                    showlegend: true
                };

                Plotly.newPlot('wipChart', chartData, layout, { responsive: true });
            }

            updateTeamChart(data) {
                let teamMetrics = data.team_metrics || {};

                // Apply workstream filtering
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);

                if (Object.keys(teamMetrics).length === 0) {
                    document.getElementById('teamChart').innerHTML = '<p class="text-center text-muted">No team data</p>';
                    return;
                }

                const sortedTeam = Object.entries(teamMetrics)
                    .sort(([,a], [,b]) => (b.completed_items || 0) - (a.completed_items || 0))
                    .slice(0, 10);

                const chartData = [{
                    x: sortedTeam.map(([name]) => name),
                    y: sortedTeam.map(([, metrics]) => metrics.completed_items || 0),
                    type: 'bar',
                    marker: { color: '#4e73df' }
                }];

                const layout = {
                    margin: { l: 50, r: 50, t: 20, b: 100 },
                    xaxis: { tickangle: -45 },
                    yaxis: { title: 'Completed Items' }
                };

                Plotly.newPlot('teamChart', chartData, layout, { responsive: true });
            }

            updateEfficiencyChart(data) {
                let flowEfficiency = data.flow_efficiency || {};
                let efficiency = (flowEfficiency.average_efficiency || 0) * 100;

                // Apply workstream filtering to efficiency calculation
                if (!this.selectedWorkstreams.includes('All Teams')) {
                    const filteredTeamMetrics = this.workstreamManager.filterTeamMetrics(data.team_metrics || {}, this.selectedWorkstreams);

                    if (Object.keys(filteredTeamMetrics).length > 0) {
                        // Recalculate efficiency for filtered teams
                        const metrics = Object.values(filteredTeamMetrics);
                        const efficiencies = metrics.map(m => m.flow_efficiency || 0).filter(e => e > 0);

                        if (efficiencies.length > 0) {
                            efficiency = (efficiencies.reduce((a, b) => a + b, 0) / efficiencies.length) * 100;
                        }
                    }
                }

                const chartData = [{
                    domain: { x: [0, 1], y: [0, 1] },
                    value: efficiency,
                    title: { text: "%" },
                    type: "indicator",
                    mode: "gauge+number",
                    gauge: {
                        axis: { range: [null, 100] },
                        bar: { color: "#4e73df" },
                        steps: [
                            { range: [0, 50], color: "lightgray" },
                            { range: [50, 80], color: "#f6c23e" },
                            { range: [80, 100], color: "#1cc88a" }
                        ]
                    }
                }];

                const layout = {
                    margin: { l: 20, r: 20, t: 20, b: 20 }
                };

                Plotly.newPlot('efficiencyChart', chartData, layout, { responsive: true });
            }

            updateTeamTable(data) {
                let teamMetrics = data.team_metrics || {};
                const tbody = document.getElementById('teamTableBody');

                // Apply workstream filtering
                teamMetrics = this.workstreamManager.filterTeamMetrics(teamMetrics, this.selectedWorkstreams);

                if (Object.keys(teamMetrics).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No team data</td></tr>';
                    return;
                }

                const sortedTeam = Object.entries(teamMetrics)
                    .sort(([,a], [,b]) => (b.completion_rate || 0) - (a.completion_rate || 0))
                    .slice(0, 10);

                const rows = sortedTeam.map(([name, metrics]) => `
                    <tr>
                        <td>${name}</td>
                        <td>${metrics.completed_items || 0}</td>
                        <td>${metrics.active_items || 0}</td>
                        <td>${(metrics.completion_rate || 0).toFixed(1)}%</td>
                        <td>${(metrics.average_lead_time || 0).toFixed(1)} days</td>
                    </tr>
                `).join('');

                tbody.innerHTML = rows;
            }

            generateMockData() {
                return {
                    summary: {
                        total_work_items: 200,
                        completed_items: 129,
                        completion_rate: 64.5
                    },
                    lead_time: {
                        average_days: 11.3,
                        median_days: 12.0,
                        count: 129
                    },
                    cycle_time: {
                        average_days: 8.8,
                        median_days: 9.0,
                        count: 129
                    },
                    throughput: {
                        items_per_period: 19.4,
                        period_days: 30
                    },
                    work_in_progress: {
                        total_wip: 50,
                        wip_by_state: {
                            "Active": 37,
                            "Resolved": 13
                        }
                    },
                    flow_efficiency: {
                        average_efficiency: 0.625
                    },
                    team_metrics: {
                        "Alice Johnson": { completed_items: 15, active_items: 3, completion_rate: 85.2, average_lead_time: 10.5 },
                        "Bob Smith": { completed_items: 12, active_items: 2, completion_rate: 92.1, average_lead_time: 8.3 },
                        "Carol Davis": { completed_items: 10, active_items: 4, completion_rate: 72.4, average_lead_time: 13.2 },
                        "David Wilson": { completed_items: 8, active_items: 1, completion_rate: 88.9, average_lead_time: 9.7 }
                    }
                };
            }

            showNoDataMessage() {
                document.getElementById('leadTimeAvg').textContent = 'No Data';
                document.getElementById('cycleTimeAvg').textContent = 'No Data';
                document.getElementById('throughputValue').textContent = 'No Data';
                document.getElementById('wipValue').textContent = 'No Data';
            }

            showErrorMessage(message) {
                this.updateDataSourceInfo('Error: ' + message);
            }

            handleWorkstreamFilter(event) {
                event.preventDefault();
                const target = event.target.closest('[data-workstream]');
                if (!target) return;

                const workstream = target.getAttribute('data-workstream');
                const checkbox = target.querySelector('input[type="checkbox"]');

                if (workstream === 'All Teams') {
                    // Toggle all teams
                    if (checkbox.checked) {
                        this.selectedWorkstreams = ['All Teams'];
                        // Uncheck all other checkboxes
                        document.querySelectorAll('#workstreamDropdownMenu input[type="checkbox"]').forEach(cb => {
                            cb.checked = cb.closest('[data-workstream]').getAttribute('data-workstream') === 'All Teams';
                        });
                    } else {
                        checkbox.checked = true; // Keep All Teams checked if trying to uncheck
                        return;
                    }
                } else {
                    // Toggle specific workstream
                    const allTeamsCheckbox = document.querySelector('[data-workstream="All Teams"] input');

                    if (checkbox.checked) {
                        // Add to selection
                        if (this.selectedWorkstreams.includes('All Teams')) {
                            this.selectedWorkstreams = [workstream];
                            allTeamsCheckbox.checked = false;
                        } else if (!this.selectedWorkstreams.includes(workstream)) {
                            this.selectedWorkstreams.push(workstream);
                        }
                    } else {
                        // Remove from selection
                        this.selectedWorkstreams = this.selectedWorkstreams.filter(w => w !== workstream);
                        if (this.selectedWorkstreams.length === 0) {
                            // If no workstreams selected, default to All Teams
                            this.selectedWorkstreams = ['All Teams'];
                            allTeamsCheckbox.checked = true;
                        }
                    }
                }

                this.updateWorkstreamDisplay();
                this.updateDashboard(this.data);
            }

            updateWorkstreamDisplay() {
                const button = document.getElementById('workstreamDropdown');
                const info = document.getElementById('workstreamInfo');

                if (this.selectedWorkstreams.includes('All Teams')) {
                    button.innerHTML = '<i class="fas fa-users me-2"></i>All Teams';
                    info.textContent = 'All teams included';
                } else if (this.selectedWorkstreams.length === 1) {
                    button.innerHTML = `<i class="fas fa-users me-2"></i>${this.selectedWorkstreams[0]}`;
                    info.textContent = `Filtered to ${this.selectedWorkstreams[0]} workstream`;
                } else {
                    button.innerHTML = `<i class="fas fa-users me-2"></i>${this.selectedWorkstreams.length} Workstreams`;
                    info.textContent = `Filtered to ${this.selectedWorkstreams.length} workstreams: ${this.selectedWorkstreams.join(', ')}`;
                }
            }

            toggleAutoRefresh(enabled) {
                if (enabled) {
                    this.autoRefreshTimer = setInterval(() => {
                        if (this.lastDataSource === 'cliData') {
                            console.log('Auto-refreshing CLI data...');
                            this.loadData();
                        }
                    }, this.autoRefreshInterval);
                    console.log('Auto-refresh enabled (30s interval)');
                } else {
                    if (this.autoRefreshTimer) {
                        clearInterval(this.autoRefreshTimer);
                        this.autoRefreshTimer = null;
                    }
                    console.log('Auto-refresh disabled');
                }
            }

            // Enhanced Features Implementation

            updatePredictiveAnalytics(data = null) {
                const currentData = data || this.data;
                if (!currentData || !currentData.historical_data) {
                    console.warn('No historical data available for predictive analytics');
                    return;
                }

                try {
                    // Initialize predictive analytics with historical data
                    this.predictiveAnalytics.initialize(currentData.historical_data);

                    // Get forecast parameters
                    const remainingItems = parseInt(document.getElementById('forecastItems').value) || 20;

                    // Generate prediction
                    const prediction = this.predictiveAnalytics.predictDeliveryDate(remainingItems, {
                        confidenceLevel: 0.85
                    });

                    // Update forecast display
                    this.updateForecastDisplay(prediction);

                    // Update velocity trend chart
                    this.updateVelocityTrendChart(prediction);

                    // Hide skeleton loading
                    this.enhancedUX.hideSkeleton('forecastChart');
                    this.enhancedUX.hideSkeleton('velocityTrendChart');

                } catch (error) {
                    console.error('Error updating predictive analytics:', error);
                    this.enhancedUX.hideSkeleton('forecastChart');
                    this.enhancedUX.hideSkeleton('velocityTrendChart');
                }
            }

            updateForecastDisplay(prediction) {
                // Update date displays
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                document.getElementById('optimisticDate').textContent = 
                    prediction.range.optimistic.toLocaleDateString('en-US', options);
                document.getElementById('realisticDate').textContent = 
                    prediction.range.realistic.toLocaleDateString('en-US', options);
                document.getElementById('pessimisticDate').textContent = 
                    prediction.range.pessimistic.toLocaleDateString('en-US', options);

                // Update trend indicators
                document.getElementById('trendDirection').textContent = prediction.velocityTrend.direction;
                document.getElementById('trendDirection').className = 
                    `badge ${this.getTrendBadgeClass(prediction.velocityTrend.direction)}`;

                document.getElementById('riskLevel').textContent = prediction.riskLevel;
                document.getElementById('riskLevel').className = 
                    `badge ${this.getRiskBadgeClass(prediction.riskLevel)}`;

                document.getElementById('forecastConfidence').textContent = 
                    `${(prediction.confidence * 100).toFixed(0)}%`;

                // Create forecast chart
                this.createForecastChart(prediction);
            }

            createForecastChart(prediction) {
                const trace1 = {
                    x: ['Optimistic', 'Realistic', 'Pessimistic'],
                    y: [
                        prediction.weeksToComplete.optimistic,
                        prediction.weeksToComplete.realistic,
                        prediction.weeksToComplete.pessimistic
                    ],
                    type: 'bar',
                    marker: {
                        color: ['#1cc88a', '#4e73df', '#f6c23e']
                    },
                    text: [
                        `${prediction.weeksToComplete.optimistic.toFixed(1)} weeks`,
                        `${prediction.weeksToComplete.realistic.toFixed(1)} weeks`,
                        `${prediction.weeksToComplete.pessimistic.toFixed(1)} weeks`
                    ],
                    textposition: 'auto'
                };

                const layout = {
                    title: {
                        text: 'Delivery Timeline Forecast',
                        font: { size: 14 }
                    },
                    xaxis: { title: 'Confidence Level' },
                    yaxis: { title: 'Weeks to Complete' },
                    margin: { t: 40, b: 40, l: 60, r: 20 },
                    showlegend: false
                };

                Plotly.newPlot('forecastChart', [trace1], layout, { responsive: true });
            }

            updateVelocityTrendChart(prediction) {
                // Create velocity trend visualization
                const velocityHistory = this.predictiveAnalytics.velocityHistory;
                const weeks = velocityHistory.map((_, i) => `Week ${i + 1}`);

                const trace = {
                    x: weeks,
                    y: velocityHistory,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#4e73df', width: 2 },
                    marker: { size: 6 }
                };

                const layout = {
                    title: {
                        text: 'Velocity Trend',
                        font: { size: 14 }
                    },
                    xaxis: { title: 'Time Period' },
                    yaxis: { title: 'Items/Week' },
                    margin: { t: 40, b: 40, l: 60, r: 20 },
                    showlegend: false
                };

                Plotly.newPlot('velocityTrendChart', [trace], layout, { responsive: true });
            }

            updateTimeSeriesAnalysis(data = null) {
                const currentData = data || this.data;
                if (!currentData) return;

                try {
                    // Prepare time series data
                    const timeSeriesData = this.prepareTimeSeriesData(currentData);
                    
                    // Initialize analyzer
                    this.timeSeriesAnalyzer.initialize(timeSeriesData);

                    // Update moving averages chart
                    this.updateMovingAverages('leadTime');

                    // Update period comparison chart
                    this.updatePeriodComparison(timeSeriesData);

                    // Hide skeleton loading
                    this.enhancedUX.hideSkeleton('movingAveragesChart');
                    this.enhancedUX.hideSkeleton('periodComparisonChart');

                } catch (error) {
                    console.error('Error updating time series analysis:', error);
                    this.enhancedUX.hideSkeleton('movingAveragesChart');
                    this.enhancedUX.hideSkeleton('periodComparisonChart');
                }
            }

            prepareTimeSeriesData(data) {
                const timeSeriesData = [];
                
                // Extract historical data points
                if (data.historical_data) {
                    data.historical_data.forEach(item => {
                        if (item.resolvedDate) {
                            timeSeriesData.push({
                                date: item.resolvedDate,
                                value: item.leadTime || 0,
                                metric: 'leadTime'
                            });
                            timeSeriesData.push({
                                date: item.resolvedDate,
                                value: item.cycleTime || 0,
                                metric: 'cycleTime'
                            });
                        }
                    });
                }

                // Add current metrics as latest data points
                const today = new Date().toISOString().split('T')[0];
                const leadTime = data.lead_time?.average_days || 0;
                const cycleTime = data.cycle_time?.average_days || 0;
                const throughput = data.throughput?.items_per_period || 0;

                timeSeriesData.push(
                    { date: today, value: leadTime, metric: 'leadTime' },
                    { date: today, value: cycleTime, metric: 'cycleTime' },
                    { date: today, value: throughput, metric: 'throughput' }
                );

                return timeSeriesData;
            }

            updateMovingAverages(metric) {
                const analysis = this.timeSeriesAnalyzer.getAnalysis(metric);
                if (!analysis) return;

                const movingAverages = analysis.movingAverages;
                const traces = [];

                // Add raw data
                traces.push({
                    x: analysis.rawData.map(d => d.date),
                    y: analysis.rawData.map(d => d.value),
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Raw Data',
                    marker: { color: '#e3e6f0', size: 4 }
                });

                // Add moving averages
                const colors = ['#4e73df', '#1cc88a', '#f6c23e'];
                movingAverages.forEach((ma, index) => {
                    traces.push({
                        x: ma.data.map(d => d.date),
                        y: ma.data.map(d => d.value),
                        type: 'scatter',
                        mode: 'lines',
                        name: `${ma.window}-day MA`,
                        line: { color: colors[index], width: 2 }
                    });
                });

                const layout = {
                    title: {
                        text: `${metric} Moving Averages`,
                        font: { size: 14 }
                    },
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Value' },
                    margin: { t: 40, b: 40, l: 60, r: 20 },
                    legend: { x: 0, y: 1 }
                };

                Plotly.newPlot('movingAveragesChart', traces, layout, { responsive: true });
            }

            updatePeriodComparison(timeSeriesData) {
                // Get period comparisons from analyzer
                const leadTimeData = timeSeriesData.filter(d => d.metric === 'leadTime');
                if (leadTimeData.length < 14) return;

                // Simple period comparison - last 7 days vs previous 7 days
                const now = new Date();
                const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const fourteenDaysAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);

                const currentPeriod = leadTimeData.filter(d => new Date(d.date) >= sevenDaysAgo);
                const previousPeriod = leadTimeData.filter(d => 
                    new Date(d.date) >= fourteenDaysAgo && new Date(d.date) < sevenDaysAgo
                );

                const currentAvg = currentPeriod.length > 0 ? 
                    currentPeriod.reduce((sum, d) => sum + d.value, 0) / currentPeriod.length : 0;
                const previousAvg = previousPeriod.length > 0 ? 
                    previousPeriod.reduce((sum, d) => sum + d.value, 0) / previousPeriod.length : 0;

                // Update display
                document.getElementById('currentPeriodValue').textContent = currentAvg.toFixed(1);
                document.getElementById('previousPeriodValue').textContent = previousAvg.toFixed(1);
                
                const change = previousAvg > 0 ? ((currentAvg - previousAvg) / previousAvg * 100) : 0;
                const changeElement = document.getElementById('periodChange');
                changeElement.textContent = `${change.toFixed(1)}%`;
                changeElement.className = `fw-bold ${change >= 0 ? 'text-warning' : 'text-success'}`;

                // Create comparison chart
                const trace = {
                    x: ['Previous Period', 'Current Period'],
                    y: [previousAvg, currentAvg],
                    type: 'bar',
                    marker: {
                        color: [currentAvg >= previousAvg ? '#f6c23e' : '#1cc88a', '#4e73df']
                    }
                };

                const layout = {
                    title: {
                        text: 'Period Comparison',
                        font: { size: 14 }
                    },
                    yaxis: { title: 'Average Lead Time (days)' },
                    margin: { t: 40, b: 40, l: 60, r: 20 },
                    showlegend: false
                };

                Plotly.newPlot('periodComparisonChart', [trace], layout, { responsive: true });
            }

            updateInsightsAndRecommendations(data = null) {
                const currentData = data || this.data;
                if (!currentData) return;

                try {
                    // Generate insights based on current metrics and trends
                    const insights = this.generateInsights(currentData);
                    const recommendations = this.generateRecommendations(currentData);

                    // Update insights cards
                    this.updateInsightCards(insights);

                    // Update recommendations list
                    this.updateRecommendationsList(recommendations);

                    // Hide skeleton loading
                    this.enhancedUX.hideSkeleton('insightCards');

                } catch (error) {
                    console.error('Error updating insights:', error);
                    this.enhancedUX.hideSkeleton('insightCards');
                }
            }

            generateInsights(data) {
                const insights = [];
                
                // Lead time insights
                const leadTime = data.lead_time?.average_days || 0;
                if (leadTime > 30) {
                    insights.push({
                        type: 'warning',
                        title: 'High Lead Time',
                        description: `Average lead time of ${leadTime.toFixed(1)} days is concerning`,
                        icon: 'exclamation-triangle'
                    });
                } else if (leadTime < 5) {
                    insights.push({
                        type: 'success',
                        title: 'Excellent Lead Time',
                        description: `Very good lead time of ${leadTime.toFixed(1)} days`,
                        icon: 'check-circle'
                    });
                }

                // Throughput insights
                const throughput = data.throughput?.items_per_period || 0;
                if (throughput < 5) {
                    insights.push({
                        type: 'info',
                        title: 'Low Throughput',
                        description: `Consider ways to increase throughput (${throughput} items/period)`,
                        icon: 'info-circle'
                    });
                }

                // WIP insights
                const wip = data.work_in_progress?.total_wip || 0;
                if (wip > 20) {
                    insights.push({
                        type: 'warning',
                        title: 'High WIP',
                        description: `${wip} items in progress may cause bottlenecks`,
                        icon: 'exclamation-triangle'
                    });
                }

                return insights;
            }

            generateRecommendations(data) {
                const recommendations = [];

                const leadTime = data.lead_time?.average_days || 0;
                const cycleTime = data.cycle_time?.average_days || 0;
                const wip = data.work_in_progress?.total_wip || 0;

                if (leadTime > cycleTime * 2) {
                    recommendations.push('Focus on reducing waiting time between work stages');
                }

                if (wip > 15) {
                    recommendations.push('Consider implementing WIP limits to improve flow');
                }

                if (leadTime > 20) {
                    recommendations.push('Break down large work items into smaller, deliverable pieces');
                }

                if (recommendations.length === 0) {
                    recommendations.push('Flow metrics look healthy. Continue monitoring for changes.');
                }

                return recommendations;
            }

            updateInsightCards(insights) {
                const container = document.getElementById('insightCards');
                
                if (insights.length === 0) {
                    container.innerHTML = '<div class="col-12"><p class="text-muted">No specific insights available.</p></div>';
                    return;
                }

                container.innerHTML = insights.map(insight => `
                    <div class="col-md-4 mb-3">
                        <div class="card border-${this.getInsightBorderClass(insight.type)}">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-${insight.icon} fa-2x text-${insight.type}"></i>
                                    </div>
                                    <div>
                                        <h6 class="card-title mb-1">${insight.title}</h6>
                                        <p class="card-text small">${insight.description}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateRecommendationsList(recommendations) {
                const container = document.getElementById('recommendationsList');
                
                container.innerHTML = recommendations.map(rec => `
                    <li class="d-flex align-items-start mb-2">
                        <i class="fas fa-arrow-right text-primary me-2 mt-1"></i>
                        <span>${rec}</span>
                    </li>
                `).join('');
            }

            // Utility methods for styling
            getTrendBadgeClass(direction) {
                switch (direction) {
                    case 'IMPROVING': return 'bg-success';
                    case 'DECLINING': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }

            getRiskBadgeClass(risk) {
                switch (risk) {
                    case 'LOW': return 'bg-success';
                    case 'MEDIUM': return 'bg-warning';
                    case 'HIGH': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }

            getInsightBorderClass(type) {
                switch (type) {
                    case 'success': return 'success';
                    case 'warning': return 'warning';
                    case 'danger': return 'danger';
                    default: return 'info';
                }
            }

            // Advanced Filtering Methods
            setupAdvancedFiltering() {
                // Initialize the advanced filtering module
                this.advancedFiltering.init();
                
                // Set up filter change callback
                this.advancedFiltering.setOnFilterChange((filters) => {
                    this.applyAdvancedFilters(filters);
                });
                
                // Set up drill-down callback
                this.advancedFiltering.setOnDrillDown((drillDownInfo) => {
                    this.handleDrillDown(drillDownInfo);
                });
                
                // Set up preset buttons
                this.setupFilterPresets();
                
                // Set up multi-select dropdowns
                this.setupMultiSelectDropdowns();
                
                // Set up date range inputs
                this.setupDateRangeInputs();
                
                // Initialize filter panel state
                this.filterPanelExpanded = false;
                
                console.log('Advanced filtering initialized');
            }

            setupFilterPresets() {
                const presetButtons = document.querySelectorAll('.preset-btn');
                presetButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const preset = btn.dataset.preset;
                        this.advancedFiltering.applyPreset(preset);
                        
                        // Update UI
                        presetButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });
            }

            setupMultiSelectDropdowns() {
                // This will be called after data is loaded
                // The actual population happens in updateFilteringDropdowns
            }

            populateMultiSelectDropdowns(availableValues) {
                const dropdowns = {
                    workItemTypes: availableValues.workItemTypes || ['User Story', 'Bug', 'Task', 'Feature'],
                    priorities: availableValues.priorities || ['Critical', 'High', 'Medium', 'Low'],
                    assignees: availableValues.assignees || ['John Doe', 'Jane Smith', 'Bob Johnson'],
                    states: availableValues.states || ['New', 'In Progress', 'Review', 'Testing', 'Done'],
                    tags: availableValues.tags || ['urgent', 'bug-fix', 'feature', 'refactor']
                };

                Object.entries(dropdowns).forEach(([key, values]) => {
                    const dropdown = document.getElementById(`${key}Dropdown`);
                    if (dropdown) {
                        dropdown.innerHTML = values.map(value => `
                            <div class="multi-select-option" data-value="${value}" onclick="toggleFilterOption('${key}', '${value}')">
                                <input type="checkbox" class="form-check-input me-2" id="${key}_${value}">
                                <label for="${key}_${value}">${value}</label>
                            </div>
                        `).join('');
                    }
                });
            }

            setupDateRangeInputs() {
                const startDate = document.getElementById('startDateFilter');
                const endDate = document.getElementById('endDateFilter');

                if (startDate && endDate) {
                    startDate.addEventListener('change', () => {
                        this.advancedFiltering.setDateRange(startDate.value, endDate.value);
                    });

                    endDate.addEventListener('change', () => {
                        this.advancedFiltering.setDateRange(startDate.value, endDate.value);
                    });
                }
            }

            applyAdvancedFilters(filters) {
                if (!this.data || !this.data.historical_data) {
                    return;
                }

                // Apply filters to the data
                const filteredData = this.advancedFiltering.applyFilters(this.data.historical_data);
                
                // Update the current data with filtered results
                const filteredDataset = { 
                    ...this.data, 
                    historical_data: filteredData 
                };
                
                // Recalculate metrics based on filtered data
                this.updateDisplayWithFilteredData(filteredDataset);
                
                // Update filter summary UI
                this.updateFilterSummaryUI();
                
                // Update filter history navigation
                this.updateFilterHistoryNav();
            }

            updateDisplayWithFilteredData(filteredData) {
                // Update metrics cards
                this.updateMetricsCards(filteredData);
                
                // Update charts
                this.updateCharts(filteredData);
                
                // Update insights and recommendations
                this.updateInsightsAndRecommendations(filteredData);
                
                // Update predictive analytics
                if (filteredData.historical_data && filteredData.historical_data.length > 0) {
                    this.predictiveAnalytics.initialize(filteredData.historical_data);
                    this.updatePredictiveAnalytics();
                }
                
                // Update time series analysis
                this.updateTimeSeriesAnalysis(filteredData);
            }

            updateFilterSummaryUI() {
                const summary = this.advancedFiltering.getFilterSummary();
                const filterCount = document.getElementById('filterCount');
                const filterChips = document.getElementById('filterChips');
                const filterSummaryDiv = document.getElementById('filterSummary');

                // Update filter count
                if (filterCount) {
                    filterCount.textContent = summary.active ? `${summary.count} active` : 'None';
                }

                // Update filter chips
                if (filterChips) {
                    filterChips.innerHTML = summary.descriptions.map(desc => `
                        <div class="filter-chip">
                            ${desc}
                            <i class="fas fa-times remove-chip" onclick="removeFilterChip('${desc}')"></i>
                        </div>
                    `).join('');
                }

                // Update summary styling
                if (filterSummaryDiv) {
                    if (summary.active) {
                        filterSummaryDiv.classList.add('active');
                    } else {
                        filterSummaryDiv.classList.remove('active');
                    }
                }
            }

            updateFilterHistoryNav() {
                const backBtn = document.getElementById('filterBackBtn');
                const forwardBtn = document.getElementById('filterForwardBtn');

                if (backBtn) {
                    backBtn.disabled = !this.advancedFiltering.canGoBack();
                }

                if (forwardBtn) {
                    forwardBtn.disabled = !this.advancedFiltering.canGoForward();
                }
            }

            handleDrillDown(drillDownInfo) {
                // Update breadcrumb
                this.updateDrillDownBreadcrumb(drillDownInfo);
                
                // Show drill-down UI
                const breadcrumb = document.getElementById('drillDownBreadcrumb');
                if (breadcrumb) {
                    breadcrumb.style.display = 'block';
                }
                
                console.log('Drill-down applied:', drillDownInfo);
            }

            updateDrillDownBreadcrumb(drillDownInfo) {
                const breadcrumbItems = document.getElementById('breadcrumbItems');
                if (breadcrumbItems) {
                    const item = document.createElement('div');
                    item.className = 'breadcrumb-item';
                    item.innerHTML = `
                        <span class="breadcrumb-link" onclick="clearDrillDown('${drillDownInfo.dimension}', '${drillDownInfo.value}')">
                            ${drillDownInfo.dimension}: ${drillDownInfo.value}
                        </span>
                    `;
                    breadcrumbItems.appendChild(item);
                }
            }

            updateTimeSeriesAnalysis(data) {
                if (!data.historical_data || data.historical_data.length === 0) {
                    return;
                }

                // Prepare time series data
                const timeSeriesData = [];
                data.historical_data.forEach(item => {
                    if (item.resolvedDate) {
                        timeSeriesData.push({
                            date: item.resolvedDate,
                            value: item.leadTime || 0,
                            metric: 'leadTime'
                        });
                        timeSeriesData.push({
                            date: item.resolvedDate,
                            value: item.cycleTime || 0,
                            metric: 'cycleTime'
                        });
                    }
                });

                // Update time series analyzer
                this.timeSeriesAnalyzer.initialize(timeSeriesData);
                
                // Update the selected metric's moving averages
                const selectedMetric = document.querySelector('input[name="maMetric"]:checked');
                if (selectedMetric) {
                    this.updateMovingAverages(selectedMetric.value);
                }
            }

            updateFilteringDropdowns(data) {
                if (!data.historical_data || data.historical_data.length === 0) {
                    return;
                }

                // Get available filter values from the data
                const availableValues = this.advancedFiltering.getAvailableFilterValues(data.historical_data);
                
                // Update multi-select dropdowns
                this.populateMultiSelectDropdowns(availableValues);
                
                console.log('Filtering dropdowns updated with data:', availableValues);
            }
        }

        // Global utility functions for filtering UI
        let dashboardInstance = null;

        function toggleFilterPanel() {
            const content = document.getElementById('filterContent');
            const icon = document.getElementById('filterToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function toggleMultiSelect(filterType) {
            const dropdown = document.getElementById(`${filterType}Dropdown`);
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        }

        function toggleFilterOption(filterType, value) {
            const checkbox = document.getElementById(`${filterType}_${value}`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                
                // Update the filter
                const selectedValues = Array.from(document.querySelectorAll(`#${filterType}Dropdown input:checked`))
                    .map(cb => cb.parentElement.dataset.value);
                
                if (dashboardInstance && dashboardInstance.advancedFiltering) {
                    switch (filterType) {
                        case 'workItemTypes':
                            dashboardInstance.advancedFiltering.setWorkItemTypes(selectedValues);
                            break;
                        case 'priorities':
                            dashboardInstance.advancedFiltering.setPriorities(selectedValues);
                            break;
                        case 'assignees':
                            dashboardInstance.advancedFiltering.setAssignees(selectedValues);
                            break;
                        case 'states':
                            dashboardInstance.advancedFiltering.setStates(selectedValues);
                            break;
                        case 'tags':
                            dashboardInstance.advancedFiltering.setTags(selectedValues);
                            break;
                    }
                }
            }
        }

        function clearAllFilters() {
            if (dashboardInstance && dashboardInstance.advancedFiltering) {
                dashboardInstance.advancedFiltering.clearAllFilters();
            }
        }

        function shareFilters() {
            if (dashboardInstance && dashboardInstance.advancedFiltering) {
                const url = dashboardInstance.advancedFiltering.getShareableUrl();
                navigator.clipboard.writeText(url).then(() => {
                    alert('Filter URL copied to clipboard!');
                }).catch(() => {
                    // Fallback for browsers that don't support clipboard API
                    const textarea = document.createElement('textarea');
                    textarea.value = url;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('Filter URL copied to clipboard!');
                });
            }
        }

        function goBackFilter() {
            if (dashboardInstance && dashboardInstance.advancedFiltering) {
                dashboardInstance.advancedFiltering.goBack();
            }
        }

        function goForwardFilter() {
            if (dashboardInstance && dashboardInstance.advancedFiltering) {
                dashboardInstance.advancedFiltering.goForward();
            }
        }

        function removeFilterChip(description) {
            // This is a simplified implementation - in a real app you'd parse the description
            // and remove the specific filter
            console.log('Remove filter chip:', description);
        }

        function saveCustomPreset() {
            const nameInput = document.getElementById('customPresetName');
            if (nameInput && nameInput.value.trim()) {
                if (dashboardInstance && dashboardInstance.advancedFiltering) {
                    dashboardInstance.advancedFiltering.savePreset(
                        nameInput.value.trim(),
                        'Custom filter preset'
                    );
                    nameInput.value = '';
                    alert('Preset saved successfully!');
                }
            }
        }

        function clearDrillDown(dimension, value) {
            if (dashboardInstance && dashboardInstance.advancedFiltering) {
                dashboardInstance.advancedFiltering.clearAllFilters();
                
                // Hide drill-down breadcrumb
                const breadcrumb = document.getElementById('drillDownBreadcrumb');
                if (breadcrumb) {
                    breadcrumb.style.display = 'none';
                }
                
                // Clear breadcrumb items
                const breadcrumbItems = document.getElementById('breadcrumbItems');
                if (breadcrumbItems) {
                    breadcrumbItems.innerHTML = '';
                }
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            dashboardInstance = new FlowDashboard();
        });
    </script>
</body>
</html>
